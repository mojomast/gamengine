<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#d62828">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Project Manager">
    <meta name="format-detection" content="telephone=no">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='50' fill='%23d62828'/><text x='50' y='55' font-size='40' text-anchor='middle' fill='white'>üìÅ</text></svg>">
    <title>Game Engine Project Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="./shared/styles.css">

    </style>
</head>
<body>
    <!-- Skip Links for Screen Readers -->
    <a href="#main-content" class="skip-link sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:bg-blue-600 focus:text-white focus:px-4 focus:py-2 focus:rounded">Skip to main content</a>
    <a href="#projects-section" class="skip-link sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-32 focus:z-50 focus:bg-blue-600 focus:text-white focus:px-4 focus:py-2 focus:rounded">Skip to projects</a>
    <a href="#recent-activity" class="skip-link sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-64 focus:z-50 focus:bg-blue-600 focus:text-white focus:px-4 focus:py-2 focus:rounded">Skip to recent activity</a>
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="text-center mb-12" role="banner">
            <h1 class="text-4xl md:text-6xl font-bold glow-text mb-4" style="font-family: 'Press Start 2P', cursive;" id="main-heading">
                PROJECT MANAGER
            </h1>
            <p class="text-xl text-green-400">Manage your game engine projects like a boss</p>
        </header>

        <!-- Quick Actions -->
        <nav aria-label="Quick actions" class="flex flex-wrap justify-center gap-4 mb-8">
            <button id="newProjectBtn" class="btn-neon" aria-label="Create new project">
                üöÄ New Project
            </button>
            <button id="importProjectBtn" class="btn-neon" aria-label="Import existing project">
                üìÅ Import Project
            </button>
            <button id="backupAllBtn" class="btn-neon" aria-label="Backup all projects">
                üíæ Backup All
            </button>
            <button id="settingsBtn" class="btn-neon" aria-label="Open settings">
                ‚öôÔ∏è Settings
            </button>
            <button id="templateManagerBtn" class="btn-neon" aria-label="Manage project templates">
                üé® Templates
            </button>
            <button id="versionManagerBtn" class="btn-neon" aria-label="Manage project versions">
                üìù Versions
            </button>
            <button id="searchBtn" class="btn-neon" aria-label="Search projects">
                üîç Search
            </button>
        </nav>

        <!-- Project Statistics -->
        <section aria-labelledby="stats-heading" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <h2 id="stats-heading" class="sr-only">Project Statistics</h2>
            <div class="bg-gray-800 p-4 rounded-lg text-center" role="status" aria-label="Total projects count">
                <div class="text-2xl font-bold text-green-400" id="totalProjects" aria-live="polite">0</div>
                <div class="text-sm text-gray-400">Total Projects</div>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg text-center" role="status" aria-label="Active projects count">
                <div class="text-2xl font-bold text-blue-400" id="activeProjects" aria-live="polite">0</div>
                <div class="text-sm text-gray-400">Active Projects</div>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg text-center" role="status" aria-label="Last backup time">
                <div class="text-2xl font-bold text-yellow-400" id="lastBackup" aria-live="polite">Never</div>
                <div class="text-sm text-gray-400">Last Backup</div>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg text-center" role="status" aria-label="Storage used">
                <div class="text-2xl font-bold text-purple-400" id="storageUsed" aria-live="polite">0 MB</div>
                <div class="text-sm text-gray-400">Storage Used</div>
            </div>
        </section>

        <main id="main-content">
        <!-- Projects Grid -->
        <section id="projects-section" aria-labelledby="projects-heading" class="mb-8">
            <h2 id="projects-heading" class="text-2xl font-bold mb-4 text-green-400">Your Projects</h2>
            <div id="projectsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" role="grid" aria-label="Project list">
                <!-- Projects will be dynamically loaded here -->
            </div>
        </section>

        <!-- Recent Activity -->
        <section id="recent-activity" aria-labelledby="activity-heading">
            <h2 id="activity-heading" class="text-2xl font-bold mb-4 text-blue-400">Recent Activity</h2>
            <div id="recentActivity" class="bg-gray-800 rounded-lg p-4 max-h-64 overflow-y-auto" role="log" aria-live="polite" aria-label="Recent activity log">
                <!-- Activity will be loaded here -->
            </div>
        </section>
        </main>

        <!-- Game Systems Preview -->
        <div class="mt-8">
            <h2 class="text-2xl font-bold mb-4 text-green-400">üéÆ Game Systems Preview</h2>
            <canvas id="gamePreviewCanvas" class="border-2 border-green-400 bg-black" width="800" height="400" aria-label="Game systems preview canvas showing interactive game mechanics" role="img"></canvas>
        </div>

        <!-- Screen Reader Announcements -->
        <div id="sr-announcements" aria-live="polite" aria-atomic="true" class="sr-only"></div>
        <div id="sr-status" aria-live="assertive" aria-atomic="true" class="sr-only"></div>
    </div>

    <!-- New Project Modal -->
    <div id="newProjectModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-green-400">Create New Project</h2>
                <button id="closeNewProjectModal" class="text-2xl text-gray-400 hover:text-white">&times;</button>
            </div>

            <form id="newProjectForm">
                <div class="mb-4">
                    <label class="block text-sm font-bold mb-2 text-blue-400">Project Name</label>
                    <input type="text" id="projectName" class="w-full p-3 bg-gray-800 border border-gray-600 rounded-lg text-white" placeholder="My Awesome Game" required>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-bold mb-2 text-blue-400">Description</label>
                    <textarea id="projectDescription" class="w-full p-3 bg-gray-800 border border-gray-600 rounded-lg text-white h-24" placeholder="Describe your game idea..."></textarea>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-bold mb-2 text-blue-400">Template</label>
                    <div id="templateList">
                        <!-- Templates will be loaded here -->
                    </div>
                </div>

                <div class="flex gap-4">
                    <button type="submit" class="btn-neon flex-1">
                        <span id="createProjectSpinner" class="hidden">
                            <div id="loadingSpinner" class="w-4 h-4 border-2 border-white border-t-transparent rounded-full inline-block mr-2"></div>
                        </span>
                        Create Project
                    </button>
                    <button type="button" id="cancelNewProject" class="bg-gray-600 px-6 py-3 rounded-lg hover:bg-gray-500">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Project Details Modal -->
    <div id="projectDetailsModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-green-400" id="projectDetailsTitle">Project Details</h2>
                <button id="closeProjectDetailsModal" class="text-2xl text-gray-400 hover:text-white">&times;</button>
            </div>

            <div id="projectDetailsContent">
                <!-- Project details will be loaded here -->
            </div>

            <div class="flex gap-4 mt-6">
                <button id="openProjectBtn" class="btn-neon flex-1">Open Project</button>
                <button id="duplicateProjectBtn" class="bg-blue-600 px-4 py-3 rounded-lg hover:bg-blue-500">Duplicate</button>
                <button id="exportProjectBtn" class="bg-purple-600 px-4 py-3 rounded-lg hover:bg-purple-500">Export</button>
                <button id="deleteProjectBtn" class="bg-red-600 px-4 py-3 rounded-lg hover:bg-red-500">Delete</button>
            </div>
        </div>
    </div>

    <!-- Search Modal -->
    <div id="searchModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-blue-400">üîç Advanced Project Search</h2>
                <button id="closeSearchModal" class="text-2xl text-gray-400 hover:text-white">&times;</button>
            </div>

            <div class="mb-6 space-y-4">
                <input type="text" id="searchInput" class="w-full p-3 bg-gray-800 border border-gray-600 rounded-lg text-white" placeholder="Search projects by name, tags, or description...">

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-bold mb-2 text-blue-400">Filter by Type</label>
                        <select id="typeFilter" class="w-full p-2 bg-gray-800 border border-gray-600 rounded text-white">
                            <option value="">All Types</option>
                            <option value="blank">Blank Project</option>
                            <option value="poker-game">Poker Game</option>
                            <option value="game-engine">Game Engine</option>
                            <option value="platformer">Platformer</option>
                            <option value="rpg">RPG</option>
                            <option value="strategy">Strategy</option>
                            <option value="puzzle">Puzzle</option>
                            <option value="racing">Racing</option>
                            <option value="simulation">Simulation</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2 text-blue-400">Sort By</label>
                        <select id="sortBy" class="w-full p-2 bg-gray-800 border border-gray-600 rounded text-white">
                            <option value="name">Name</option>
                            <option value="created">Date Created</option>
                            <option value="modified">Last Modified</option>
                            <option value="size">File Size</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2 text-blue-400">Sort Order</label>
                        <select id="sortOrder" class="w-full p-2 bg-gray-800 border border-gray-600 rounded text-white">
                            <option value="asc">Ascending</option>
                            <option value="desc">Descending</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="searchResults" class="space-y-4 max-h-96 overflow-y-auto">
                <!-- Search results will be loaded here -->
            </div>

            <div id="searchStats" class="mt-4 text-sm text-gray-400">
                <!-- Search statistics will be shown here -->
            </div>
        </div>
    </div>

    <!-- Enhanced Project Management System -->
    <script src="js/project-preservation.js"></script>
    <script src="js/project-workflow.js"></script>
    <script src="js/project-manager.js"></script>

    <!-- Game Engine Systems - Inlined -->
    <script>
        // All game engine code will be inlined here
        // Classes: ParticleSystem, AnimationManager, UIManager, DialogManager, Character, InventoryManager, AbilityManager, GameEngine

        // Particle System
        class Particle {
            constructor(x, y, options = {}) {
                this.position = { x, y };
                this.startPosition = { x, y };
                this.velocity = {
                    x: options.velocityX || 0,
                    y: options.velocityY || 0
                };
                this.acceleration = {
                    x: options.accelerationX || 0,
                    y: options.accelerationY || 0
                };

                this.life = options.life || 1000;
                this.maxLife = this.life;
                this.size = options.size || 5;
                this.startSize = this.size;
                this.endSize = options.endSize !== undefined ? options.endSize : this.size;

                this.color = options.color || '#ffffff';
                this.startColor = options.startColor || this.color;
                this.endColor = options.endColor || this.color;

                this.alpha = options.alpha !== undefined ? options.alpha : 1;
                this.startAlpha = options.startAlpha !== undefined ? options.startAlpha : this.alpha;
                this.endAlpha = options.endAlpha !== undefined ? options.endAlpha : 0;

                this.rotation = options.rotation || 0;
                this.angularVelocity = options.angularVelocity || 0;

                this.friction = options.friction !== undefined ? options.friction : 1;
                this.gravity = options.gravity || 0;

                this.shape = options.shape || 'circle';
                this.texture = options.texture || null;

                this.alive = true;
                this.age = 0;
            }

            update(deltaTime) {
                if (!this.alive) return;

                const dt = deltaTime * 1000;
                this.age += dt;

                if (this.age >= this.life) {
                    this.alive = false;
                    return;
                }

                const progress = this.age / this.life;

                this.velocity.x += this.acceleration.x * deltaTime;
                this.velocity.y += this.acceleration.y * deltaTime;

                this.velocity.y += this.gravity * deltaTime;

                this.velocity.x *= this.friction;
                this.velocity.y *= this.friction;

                this.position.x += this.velocity.x * deltaTime;
                this.position.y += this.velocity.y * deltaTime;

                this.rotation += this.angularVelocity * deltaTime;

                this.size = this.lerp(this.startSize, this.endSize, progress);
                this.alpha = this.lerp(this.startAlpha, this.endAlpha, progress);

                if (this.startColor !== this.endColor) {
                    this.color = this.lerpColor(this.startColor, this.endColor, progress);
                }
            }

            render(ctx) {
                if (!this.alive || this.alpha <= 0) return;

                ctx.save();
                ctx.globalAlpha = this.alpha;
                ctx.translate(this.position.x, this.position.y);
                ctx.rotate(this.rotation);

                if (this.texture) {
                    ctx.drawImage(
                        this.texture,
                        -this.size / 2,
                        -this.size / 2,
                        this.size,
                        this.size
                    );
                } else {
                    ctx.fillStyle = this.color;
                    this.renderShape(ctx);
                }

                ctx.restore();
            }

            renderShape(ctx) {
                const halfSize = this.size / 2;

                switch (this.shape) {
                    case 'circle':
                        ctx.beginPath();
                        ctx.arc(0, 0, halfSize, 0, Math.PI * 2);
                        ctx.fill();
                        break;

                    case 'square':
                        ctx.fillRect(-halfSize, -halfSize, this.size, this.size);
                        break;

                    case 'triangle':
                        ctx.beginPath();
                        ctx.moveTo(0, -halfSize);
                        ctx.lineTo(-halfSize, halfSize);
                        ctx.lineTo(halfSize, halfSize);
                        ctx.closePath();
                        ctx.fill();
                        break;

                    case 'star':
                        this.renderStar(ctx, 0, 0, 5, halfSize, halfSize * 0.5);
                        break;

                    default:
                        ctx.fillRect(-halfSize, -halfSize, this.size, this.size);
                }
            }

            renderStar(ctx, cx, cy, spikes, outerRadius, innerRadius) {
                let rot = Math.PI / 2 * 3;
                let x = cx;
                let y = cy;
                const step = Math.PI / spikes;

                ctx.beginPath();
                ctx.moveTo(cx, cy - outerRadius);

                for (let i = 0; i < spikes; i++) {
                    x = cx + Math.cos(rot) * outerRadius;
                    y = cy + Math.sin(rot) * outerRadius;
                    ctx.lineTo(x, y);
                    rot += step;

                    x = cx + Math.cos(rot) * innerRadius;
                    y = cy + Math.sin(rot) * innerRadius;
                    ctx.lineTo(x, y);
                    rot += step;
                }

                ctx.lineTo(cx, cy - outerRadius);
                ctx.closePath();
                ctx.fill();
            }

            lerp(start, end, t) {
                return start + (end - start) * t;
            }

            lerpColor(start, end, t) {
                if (start === end) return start;
                return t < 0.5 ? start : end;
            }
        }

        class ParticleSystem {
            constructor(engine) {
                this.engine = engine;
                this.particles = [];
                this.emitters = new Map();
                this.maxParticles = 1000;
                this.enabled = true;
            }

            update(deltaTime) {
                if (!this.enabled) return;

                this.particles.forEach(particle => {
                    particle.update(deltaTime);
                });

                this.particles = this.particles.filter(particle => particle.alive);

                this.emitters.forEach(emitter => {
                    if (emitter.active) {
                        emitter.update(deltaTime);
                    }
                });

                if (this.particles.length > this.maxParticles) {
                    this.particles.splice(0, this.particles.length - this.maxParticles);
                }
            }

            render(ctx) {
                if (!this.enabled) return;

                this.particles.forEach(particle => {
                    particle.render(ctx);
                });
            }

            addParticle(x, y, options = {}) {
                const particle = new Particle(x, y, options);
                this.particles.push(particle);
                return particle;
            }

            createExplosion(x, y, options = {}) {
                const count = options.count || 20;
                const colors = options.colors || ['#ff0000', '#ff8000', '#ffff00', '#ffffff'];
                const speed = options.speed || 200;

                for (let i = 0; i < count; i++) {
                    const angle = (Math.PI * 2 * i) / count;
                    const velocity = speed * (0.5 + Math.random() * 0.5);

                    this.addParticle(x, y, {
                        velocityX: Math.cos(angle) * velocity,
                        velocityY: Math.sin(angle) * velocity,
                        color: colors[Math.floor(Math.random() * colors.length)],
                        size: 3 + Math.random() * 5,
                        endSize: 0,
                        life: 500 + Math.random() * 500,
                        friction: 0.95,
                        shape: 'circle'
                    });
                }
            }

            createRainbowBurst(x, y, options = {}) {
                const count = options.count || 15;
                const rainbowColors = [
                    '#ff0000', '#ff8000', '#ffff00', '#80ff00',
                    '#00ff80', '#00ffff', '#0080ff', '#0000ff',
                    '#8000ff', '#ff00ff', '#ff0080'
                ];

                for (let i = 0; i < count; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const speed = 100 + Math.random() * 200;

                    this.addParticle(x, y, {
                        velocityX: Math.cos(angle) * speed,
                        velocityY: Math.sin(angle) * speed,
                        color: rainbowColors[i % rainbowColors.length],
                        size: 4 + Math.random() * 6,
                        endSize: 1,
                        life: 1000 + Math.random() * 1000,
                        friction: 0.98,
                        gravity: 50,
                        shape: 'star'
                    });
                }
            }

            createFloatingText(x, y, text, options = {}) {
                const textParticle = {
                    position: { x, y },
                    velocity: { x: 0, y: options.velocityY || -100 },
                    life: options.life || 2000,
                    maxLife: options.life || 2000,
                    age: 0,
                    text: text,
                    color: options.color || '#ffffff',
                    fontSize: options.fontSize || 24,
                    font: options.font || 'bold 24px monospace',
                    alpha: 1,
                    alive: true,

                    update(deltaTime) {
                        if (!this.alive) return;

                        this.age += deltaTime * 1000;
                        if (this.age >= this.life) {
                            this.alive = false;
                            return;
                        }

                        const progress = this.age / this.life;
                        this.position.y += this.velocity.y * deltaTime;
                        this.alpha = 1 - progress;
                    },

                    render(ctx) {
                        if (!this.alive) return;

                        ctx.save();
                        ctx.globalAlpha = this.alpha;
                        ctx.fillStyle = this.color;
                        ctx.font = this.font;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                        ctx.shadowBlur = 4;
                        ctx.fillText(this.text, this.position.x, this.position.y);
                        ctx.restore();
                    }
                };

                this.particles.push(textParticle);
                return textParticle;
            }

            createClickEffect(x, y, options = {}) {
                const count = options.count || 8;
                const colors = options.colors || ['#00f593', '#05d9e8', '#ff206e'];

                for (let i = 0; i < count; i++) {
                    const angle = (Math.PI * 2 * i) / count + Math.random() * 0.5;
                    const speed = 150 + Math.random() * 100;

                    this.addParticle(x, y, {
                        velocityX: Math.cos(angle) * speed,
                        velocityY: Math.sin(angle) * speed,
                        color: colors[Math.floor(Math.random() * colors.length)],
                        size: 2 + Math.random() * 3,
                        endSize: 0,
                        life: 300 + Math.random() * 200,
                        friction: 0.9,
                        shape: 'circle'
                    });
                }
            }

            createTrail(x, y, options = {}) {
                this.addParticle(x + (Math.random() - 0.5) * 10, y + (Math.random() - 0.5) * 10, {
                    velocityX: (Math.random() - 0.5) * 50,
                    velocityY: (Math.random() - 0.5) * 50,
                    color: options.color || '#ffffff',
                    size: options.size || 3,
                    endSize: 0,
                    life: options.life || 500,
                    friction: 0.95,
                    shape: options.shape || 'circle'
                });
            }

            createParticleEmitter(id, x, y, options = {}) {
                const emitter = {
                    id,
                    position: { x, y },
                    active: true,
                    rate: options.rate || 10,
                    timer: 0,
                    duration: options.duration || -1,
                    elapsed: 0,
                    particleOptions: options.particleOptions || {},

                    update(deltaTime) {
                        if (!this.active) return;

                        this.elapsed += deltaTime * 1000;
                        this.timer += deltaTime * 1000;

                        if (this.duration > 0 && this.elapsed >= this.duration) {
                            this.active = false;
                            return;
                        }

                        const interval = 1000 / this.rate;
                        while (this.timer >= interval) {
                            this.emitParticle();
                            this.timer -= interval;
                        }
                    },

                    emitParticle() {
                        const particleOptions = { ...this.particleOptions };

                        if (particleOptions.randomVelocity) {
                            const angle = Math.random() * Math.PI * 2;
                            const speed = particleOptions.speed || 100;
                            particleOptions.velocityX = Math.cos(angle) * speed * (0.5 + Math.random() * 0.5);
                            particleOptions.velocityY = Math.sin(angle) * speed * (0.5 + Math.random() * 0.5);
                        }

                        if (particleOptions.randomSize) {
                            particleOptions.size = particleOptions.baseSize || 5 + Math.random() * 3;
                        }

                        this.engine.particleSystem.addParticle(
                            this.position.x + (Math.random() - 0.5) * (particleOptions.spread || 0),
                            this.position.y + (Math.random() - 0.5) * (particleOptions.spread || 0),
                            particleOptions
                        );
                    }
                };

                this.emitters.set(id, emitter);
                return emitter;
            }

            removeEmitter(id) {
                this.emitters.delete(id);
            }

            moveEmitter(id, x, y) {
                const emitter = this.emitters.get(id);
                if (emitter) {
                    emitter.position.x = x;
                    emitter.position.y = y;
                }
            }

            clear() {
                this.particles = [];
                this.emitters.clear();
            }

            setEnabled(enabled) {
                this.enabled = enabled;
            }

            getParticleCount() {
                return this.particles.length;
            }

            getEmitterCount() {
                return this.emitters.size;
            }
        }

        // Animation Framework (depends on ParticleSystem)
        class Tween {
            constructor(target, properties, duration, options = {}) {
                this.target = target;
                this.properties = properties;
                this.duration = duration;
                this.elapsed = 0;
                this.completed = false;
                this.started = false;

                this.easing = options.easing || Tween.Easing.linear;
                this.delay = options.delay || 0;
                this.repeat = options.repeat || 0;
                this.yoyo = options.yoyo || false;
                this.onStart = options.onStart;
                this.onUpdate = options.onUpdate;
                this.onComplete = options.onComplete;

                this.startValues = {};
                this.endValues = {};
                this.currentRepeat = 0;
                this.isReversed = false;

                this.parseProperties();
            }

            parseProperties() {
                for (const prop in this.properties) {
                    this.startValues[prop] = this.getNestedProperty(this.target, prop);
                    this.endValues[prop] = this.properties[prop];
                }
            }

            getNestedProperty(obj, path) {
                return path.split('.').reduce((current, key) => current && current[key], obj);
            }

            setNestedProperty(obj, path, value) {
                const keys = path.split('.');
                const lastKey = keys.pop();
                const target = keys.reduce((current, key) => current && current[key], obj);
                if (target) {
                    target[lastKey] = value;
                }
            }

            update(deltaTime) {
                if (this.completed) return false;

                this.elapsed += deltaTime * 1000;

                if (this.elapsed < this.delay) return true;

                const adjustedElapsed = this.elapsed - this.delay;

                if (!this.started) {
                    this.started = true;
                    if (this.onStart) this.onStart(this.target);
                }

                let progress = Math.min(adjustedElapsed / this.duration, 1);

                if (this.isReversed) {
                    progress = 1 - progress;
                }

                const easedProgress = this.easing(progress);

                for (const prop in this.properties) {
                    const start = this.isReversed ? this.endValues[prop] : this.startValues[prop];
                    const end = this.isReversed ? this.startValues[prop] : this.endValues[prop];
                    const current = start + (end - start) * easedProgress;
                    this.setNestedProperty(this.target, prop, current);
                }

                if (this.onUpdate) this.onUpdate(this.target, easedProgress);

                if (adjustedElapsed >= this.duration) {
                    if (this.yoyo && !this.isReversed) {
                        this.isReversed = true;
                        this.elapsed = this.delay;
                        return true;
                    }

                    if (this.repeat > 0 && this.currentRepeat < this.repeat) {
                        this.currentRepeat++;
                        this.elapsed = this.delay;
                        this.isReversed = false;
                        this.started = false;
                        return true;
                    }

                    this.completed = true;
                    if (this.onComplete) this.onComplete(this.target);
                    return false;
                }

                return true;
            }

            stop() {
                this.completed = true;
            }

            reset() {
                this.elapsed = 0;
                this.completed = false;
                this.started = false;
                this.currentRepeat = 0;
                this.isReversed = false;
            }

            static Easing = {
                linear: (t) => t,
                easeInQuad: (t) => t * t,
                easeOutQuad: (t) => t * (2 - t),
                easeInOutQuad: (t) => t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t,
                easeInCubic: (t) => t * t * t,
                easeOutCubic: (t) => (--t) * t * t + 1,
                easeInOutCubic: (t) => t < 0.5 ? 4 * t * t * t : (t - 1) * (2 * t - 2) * (2 * t - 2) + 1,
                easeInQuart: (t) => t * t * t * t,
                easeOutQuart: (t) => 1 - (--t) * t * t * t,
                easeInOutQuart: (t) => t < 0.5 ? 8 * t * t * t * t : 1 - 8 * (--t) * t * t * t,
                easeInBounce: (t) => 1 - Tween.Easing.easeOutBounce(1 - t),
                easeOutBounce: (t) => {
                    const n1 = 7.5625;
                    const d1 = 2.75;

                    if (t < 1 / d1) {
                        return n1 * t * t;
                    } else if (t < 2 / d1) {
                        return n1 * (t -= 1.5 / d1) * t + 0.75;
                    } else if (t < 2.5 / d1) {
                        return n1 * (t -= 2.25 / d1) * t + 0.9375;
                    } else {
                        return n1 * (t -= 2.625 / d1) * t + 0.984375;
                    }
                }
            };
        }

        class AnimationManager {
            constructor(engine) {
                this.engine = engine;
                this.tweens = [];
                this.keyframeAnimations = new Map();
                this.timelines = new Map();
                this.animationGroups = new Map();
                this.spriteAnimators = new Map();
                this.animatedParticleSystem = null;
                this.globalTimeScale = 1;
            }

            update(deltaTime) {
                const scaledDelta = deltaTime * this.globalTimeScale;

                this.tweens = this.tweens.filter(tween => tween.update(scaledDelta));

                this.keyframeAnimations.forEach((animation, id) => {
                    if (!animation.update(scaledDelta)) {
                        this.keyframeAnimations.delete(id);
                    }
                });

                this.timelines.forEach((timeline, id) => {
                    timeline.update(scaledDelta);
                });

                this.spriteAnimators.forEach((animator, id) => {
                    animator.update(scaledDelta);
                });

                this.animationGroups.forEach((group, id) => {
                    group.update(scaledDelta);
                });

                if (this.animatedParticleSystem) {
                    this.animatedParticleSystem.update(scaledDelta);
                }
            }

            to(target, properties, duration, options = {}) {
                const tween = new Tween(target, properties, duration, options);
                this.tweens.push(tween);
                return tween;
            }

            fadeIn(target, duration = 500, options = {}) {
                const initialAlpha = target.alpha || 0;
                target.alpha = 0;
                return this.to(target, { alpha: options.targetAlpha || 1 }, duration, options);
            }

            fadeOut(target, duration = 500, options = {}) {
                return this.to(target, { alpha: 0 }, duration, options);
            }

            slideIn(target, direction = 'left', distance = 100, duration = 500, options = {}) {
                const prop = direction === 'left' || direction === 'right' ? 'position.x' : 'position.y';
                const multiplier = direction === 'left' || direction === 'up' ? -1 : 1;

                const startValue = this.getNestedProperty(target, prop);
                this.setNestedProperty(target, prop, startValue + distance * multiplier);

                return this.to(target, { [prop]: startValue }, duration, options);
            }

            scale(target, fromScale = 0, toScale = 1, duration = 500, options = {}) {
                target.scale = { x: fromScale, y: fromScale };
                return this.to(target, { 'scale.x': toScale, 'scale.y': toScale }, duration, options);
            }

            killTweensOf(target) {
                this.tweens = this.tweens.filter(tween => {
                    if (tween.target === target) {
                        tween.stop();
                        return false;
                    }
                    return true;
                });
            }

            killAll() {
                this.tweens.forEach(tween => tween.stop());
                this.tweens = [];
            }

            getNestedProperty(obj, path) {
                return path.split('.').reduce((current, key) => current && current[key], obj);
            }

            setNestedProperty(obj, path, value) {
                const keys = path.split('.');
                const lastKey = keys.pop();
                const target = keys.reduce((current, key) => current && current[key], obj);
                if (target) {
                    target[lastKey] = value;
                }
            }
        }

        // Core Game Engine (depends on AnimationManager)
        class GameEngine {
            constructor(canvasId, options = {}) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas?.getContext('2d');

                this.config = {
                    fps: options.fps || 60,
                    pixelArt: options.pixelArt || false,
                    responsive: options.responsive !== false,
                    audioEnabled: options.audioEnabled !== false,
                    touchEnabled: options.touchEnabled !== false,
                    ...options
                };

                this.scenes = new Map();
                this.currentScene = null;
                this.isRunning = false;
                this.lastFrameTime = 0;
                this.deltaTime = 0;
                this.frameCount = 0;

                this.gameState = {
                    score: 0,
                    level: 1,
                    health: 100,
                    maxHealth: 100,
                    resources: {},
                    flags: {},
                    persistent: {}
                };

                this.inputManager = null;
                this.audioManager = null;
                this.particleSystem = null;
                this.uiManager = null;
                this.animationManager = null;

                this.performance = {
                    fps: 0,
                    frameTime: 0,
                    lastSecond: 0,
                    frameCount: 0
                };

                this.init();
            }

            async init() {
                try {
                    this.setupCanvas();
                    await this.initializeSystems();
                    this.setupEventListeners();
                    console.log('Game Engine initialized successfully');
                } catch (error) {
                    console.error('Failed to initialize Game Engine:', error);
                }
            }

            setupCanvas() {
                if (!this.canvas) {
                    console.error('Canvas element not found');
                    return;
                }

                this.resizeCanvas();

                if (this.config.pixelArt) {
                    this.ctx.imageSmoothingEnabled = false;
                    this.canvas.style.imageRendering = 'pixelated';
                }

                this.canvas.style.display = 'block';
                this.canvas.style.touchAction = 'none';
            }

            resizeCanvas() {
                if (!this.canvas) return;

                if (this.config.responsive) {
                    const rect = this.canvas.parentElement.getBoundingClientRect();
                    this.canvas.width = rect.width;
                    this.canvas.height = rect.height;
                }
            }

            async initializeSystems() {
                // Initialize systems without dynamic imports
                try {
                    this.particleSystem = new ParticleSystem(this);
                    this.animationManager = new AnimationManager(this);

                } catch (error) {
                    console.warn('Some systems failed to initialize:', error);
                }
            }

            setupEventListeners() {
                if (this.config.responsive) {
                    window.addEventListener('resize', () => this.resizeCanvas());
                }

                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        this.pause();
                    } else {
                        this.resume();
                    }
                });
            }

            addScene(name, scene) {
                if (typeof scene.update !== 'function' || typeof scene.render !== 'function') {
                    throw new Error('Scene must have update() and render() methods');
                }

                scene.engine = this;
                this.scenes.set(name, scene);

                if (scene.init) {
                    scene.init();
                }
            }

            switchScene(name) {
                const scene = this.scenes.get(name);
                if (!scene) {
                    console.error(`Scene "${name}" not found`);
                    return;
                }

                if (this.currentScene && this.currentScene.exit) {
                    this.currentScene.exit();
                }

                this.currentScene = scene;
                if (scene.enter) {
                    scene.enter();
                }

                console.log(`Switched to scene: ${name}`);
            }

            setState(key, value) {
                this.gameState[key] = value;
                this.triggerStateChange(key, value);
            }

            getState(key) {
                return this.gameState[key];
            }

            triggerStateChange(key, value) {
                const event = new CustomEvent('statechange', {
                    detail: { key, value, state: this.gameState }
                });
                window.dispatchEvent(event);
            }

            start() {
                if (this.isRunning) return;

                this.isRunning = true;
                this.lastFrameTime = performance.now();
                this.gameLoop();

                console.log('Game engine started');
            }

            stop() {
                this.isRunning = false;
                console.log('Game engine stopped');
            }

            pause() {
                if (!this.isRunning) return;
                this.isRunning = false;
                console.log('Game engine paused');
            }

            resume() {
                if (this.isRunning) return;
                this.isRunning = true;
                this.lastFrameTime = performance.now();
                this.gameLoop();
                console.log('Game engine resumed');
            }

            gameLoop() {
                if (!this.isRunning) return;

                const currentTime = performance.now();
                this.deltaTime = (currentTime - this.lastFrameTime) / 1000;
                this.lastFrameTime = currentTime;
                this.frameCount++;

                this.updatePerformanceMetrics(currentTime);

                this.update(this.deltaTime);
                this.render();

                requestAnimationFrame(() => this.gameLoop());
            }

            update(deltaTime) {
                if (this.currentScene) {
                    this.currentScene.update(deltaTime);
                }

                if (this.animationManager) {
                    this.animationManager.update(deltaTime);
                }

                if (this.particleSystem) {
                    this.particleSystem.update(deltaTime);
                }

                if (this.uiManager) {
                    this.uiManager.update(deltaTime);
                }
            }

            render() {
                if (!this.ctx) return;

                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                if (this.currentScene) {
                    this.currentScene.render(this.ctx);
                }

                if (this.particleSystem) {
                    this.particleSystem.render(this.ctx);
                }

                if (this.uiManager) {
                    this.uiManager.render(this.ctx);
                }

                if (this.config.debug) {
                    this.renderDebugInfo();
                }
            }

            updatePerformanceMetrics(currentTime) {
                this.performance.frameCount++;

                if (currentTime - this.performance.lastSecond >= 1000) {
                    this.performance.fps = this.performance.frameCount;
                    this.performance.frameCount = 0;
                    this.performance.lastSecond = currentTime;
                }

                this.performance.frameTime = this.deltaTime * 1000;
            }

            renderDebugInfo() {
                if (!this.ctx) return;

                this.ctx.save();
                this.ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                this.ctx.fillRect(10, 10, 200, 100);

                this.ctx.fillStyle = '#00ff00';
                this.ctx.font = '12px monospace';
                this.ctx.fillText(`FPS: ${this.performance.fps}`, 15, 30);
                this.ctx.fillText(`Frame Time: ${this.performance.frameTime.toFixed(2)}ms`, 15, 45);
                this.ctx.fillText(`Scene: ${this.currentScene ? this.currentScene.constructor.name : 'None'}`, 15, 60);
                this.ctx.fillText(`Objects: ${this.currentScene ? this.currentScene.gameObjects?.length || 0 : 0}`, 15, 75);
                this.ctx.restore();
            }

            distance(a, b) {
                const dx = a.x - b.x;
                const dy = a.y - b.y;
                return Math.sqrt(dx * dx + dy * dy);
            }

            lerp(start, end, factor) {
                return start + (end - start) * factor;
            }

            clamp(value, min, max) {
                return Math.min(Math.max(value, min), max);
            }

            randomRange(min, max) {
                return Math.random() * (max - min) + min;
            }

            shake(intensity = 5, duration = 200) {
                if (this.canvas) {
                    const startTime = performance.now();
                    const animate = () => {
                        const elapsed = performance.now() - startTime;
                        if (elapsed < duration) {
                            const factor = 1 - (elapsed / duration);
                            const offsetX = (Math.random() - 0.5) * intensity * factor;
                            const offsetY = (Math.random() - 0.5) * intensity * factor;

                            this.canvas.style.transform = `translate(${offsetX}px, ${offsetY}px)`;
                            requestAnimationFrame(animate);
                        } else {
                            this.canvas.style.transform = '';
                        }
                    };
                    animate();
                }
            }

            on(event, callback) {
                window.addEventListener(event, callback);
            }

            off(event, callback) {
                window.removeEventListener(event, callback);
            }

            emit(event, data) {
                const customEvent = new CustomEvent(event, { detail: data });
                window.dispatchEvent(customEvent);
            }
        }

        // Character Stats System
        class Character {
            constructor(options = {}) {
                this.health = options.health || 100;
                this.maxHealth = options.maxHealth || 100;
                this.mana = options.mana || 50;
                this.maxMana = options.maxMana || 50;
                this.level = options.level || 1;
                this.experience = options.experience || 0;
                this.experienceToNext = this.calculateExpToNext();

                this.strength = options.strength || 10;
                this.agility = options.agility || 10;
                this.intelligence = options.intelligence || 10;

                this.statusEffects = new Map();
            }

            update(deltaTime) {
                this.updateStatusEffects(deltaTime);
            }

            gainExperience(amount) {
                this.experience += amount;

                while (this.experience >= this.experienceToNext) {
                    this.levelUp();
                }
            }

            levelUp() {
                this.experience -= this.experienceToNext;
                this.level++;

                this.maxHealth += 10;
                this.health = this.maxHealth;
                this.maxMana += 5;
                this.mana = this.maxMana;

                this.experienceToNext = this.calculateExpToNext();
            }

            calculateExpToNext() {
                return this.level * 100;
            }

            addStatusEffect(id, duration, effect = {}) {
                this.statusEffects.set(id, {
                    id,
                    duration,
                    effect,
                    startTime: Date.now()
                });

                if (effect.onApply) {
                    effect.onApply(this);
                }
            }

            removeStatusEffect(id) {
                const status = this.statusEffects.get(id);
                if (status) {
                    if (status.effect.onRemove) {
                        status.effect.onRemove(this);
                    }
                    this.statusEffects.delete(id);
                }
            }

            updateStatusEffects(deltaTime) {
                for (const [id, status] of this.statusEffects) {
                    status.duration -= deltaTime;

                    if (status.effect.onTick) {
                        status.effect.onTick(this, deltaTime);
                    }

                    if (status.duration <= 0) {
                        if (status.effect.onRemove) {
                            status.effect.onRemove(this);
                        }
                        this.statusEffects.delete(id);
                    }
                }
            }

            getAttackPower() {
                return this.strength * 2 + this.level;
            }

            getDefense() {
                return this.agility + this.level;
            }

            getMagicPower() {
                return this.intelligence * 1.5 + this.level;
            }

            getDodgeChance() {
                return Math.min(0.5, this.agility * 0.01);
            }

            takeDamage(damage) {
                this.health -= damage;
                if (this.health <= 0) {
                    this.health = 0;
                }
            }

            heal(amount) {
                this.health = Math.min(this.maxHealth, this.health + amount);
            }

            useMana(amount) {
                if (this.mana >= amount) {
                    this.mana -= amount;
                    return true;
                }
                return false;
            }

            restoreMana(amount) {
                this.mana = Math.min(this.maxMana, this.mana + amount);
            }

            isAlive() {
                return this.health > 0;
            }
        }

        // Inventory Management Module
        class Item {
            constructor(id, name, description, rarity = 'common', value = 0, stackable = false, maxStack = 1) {
                this.id = id;
                this.name = name;
                this.description = description;
                this.rarity = rarity;
                this.value = value;
                this.stackable = stackable;
                this.maxStack = maxStack;
                this.quantity = 1;
                this.quality = 1.0;
            }

            clone(quantity = 1) {
                const item = new Item(this.id, this.name, this.description, this.rarity, this.value, this.stackable, this.maxStack);
                item.quantity = quantity;
                item.quality = this.quality;
                return item;
            }
        }

        class Equipment extends Item {
            constructor(id, name, description, slot, stats = {}, rarity, value, stackable = false, maxStack = 1) {
                super(id, name, description, rarity, value, stackable, maxStack);
                this.slot = slot;
                this.stats = stats;
            }
        }

        class Weapon extends Equipment {
            constructor(id, name, description, damage, weaponType, rarity, value) {
                super(id, name, description, 'weapon', { attack: damage }, rarity, value, false, 1);
                this.damage = damage;
                this.weaponType = weaponType;
            }
        }

        class Armor extends Equipment {
            constructor(id, name, description, defense, armorType, slot, rarity, value) {
                super(id, name, description, slot, { defense: defense }, rarity, value, false, 1);
                this.defense = defense;
                this.armorType = armorType;
            }
        }

        class Consumable extends Item {
            constructor(id, name, description, effect, maxUses, rarity, value) {
                super(id, name, description, rarity, value, true, maxUses);
                this.effect = effect;
                this.maxUses = maxUses;
            }

            use(character) {
                if (this.quantity > 0) {
                    if (typeof this.effect === 'function') {
                        this.effect(character);
                    }
                    this.quantity--;
                    return true;
                }
                return false;
            }
        }

        class InventoryManager {
            constructor(capacity = 50) {
                this.capacity = capacity;
                this.inventory = new Map();
                this.equipmentSlots = {
                    helmet: null,
                    chest: null,
                    weapon: null,
                    boots: null,
                    gloves: null,
                    amulet: null
                };
                this.recipes = new Map();
            }

            addItem(item, slot = null) {
                if (this.inventory.size >= this.capacity && !slot) return false;

                if (item.stackable) {
                    for (const [s, i] of this.inventory) {
                        if (i.id === item.id && i.quantity < i.maxStack) {
                            const canAdd = Math.min(item.quantity, i.maxStack - i.quantity);
                            i.quantity += canAdd;
                            item.quantity -= canAdd;
                            if (item.quantity <= 0) return true;
                        }
                    }
                }

                let targetSlot = slot || this.findEmptySlot();
                if (targetSlot !== null) {
                    this.inventory.set(targetSlot, item);
                    return true;
                }
                return false;
            }

            removeItem(slot, quantity = 1) {
                if (!this.inventory.has(slot)) return null;
                const item = this.inventory.get(slot);
                if (item.quantity <= quantity) {
                    this.inventory.delete(slot);
                } else {
                    item.quantity -= quantity;
                    return item.clone(quantity);
                }
                return item;
            }

            findEmptySlot() {
                for (let i = 0; i < this.capacity; i++) {
                    if (!this.inventory.has(i)) return i;
                }
                return null;
            }

            equipItem(slot, equipmentSlot) {
                if (!this.inventory.has(slot) || !(this.inventory.get(slot) instanceof Equipment)) return false;
                const item = this.inventory.get(slot);
                if (this.equipmentSlots[equipmentSlot]) {
                    const oldItem = this.equipmentSlots[equipmentSlot];
                    this.equipmentSlots[equipmentSlot] = item;
                    this.inventory.set(slot, oldItem);
                } else {
                    this.equipmentSlots[equipmentSlot] = item;
                    this.inventory.delete(slot);
                }
                return true;
            }

            unequipItem(equipmentSlot, toSlot = null) {
                if (!this.equipmentSlots[equipmentSlot]) return false;
                const item = this.equipmentSlots[equipmentSlot];
                let targetSlot = toSlot || this.findEmptySlot();
                if (targetSlot !== null) {
                    this.inventory.set(targetSlot, item);
                    this.equipmentSlots[equipmentSlot] = null;
                    return true;
                }
                return false;
            }

            getEquipmentStats() {
                let totalStats = { attack: 0, defense: 0 };
                for (const slot in this.equipmentSlots) {
                    const item = this.equipmentSlots[slot];
                    if (item) {
                        for (const stat in item.stats) {
                            totalStats[stat] = (totalStats[stat] || 0) + item.stats[stat] * item.quality;
                        }
                    }
                }
                return totalStats;
            }

            getItemAtSlot(slot) {
                return this.inventory.get(slot) || null;
            }

            getEquipmentAtSlot(slot) {
                return this.equipmentSlots[slot] || null;
            }
        }

        // Abilities System
        class BaseAbility {
            constructor(name, description, type, targeting, cooldown, resourceCost, resourceType, level = 1) {
                this.name = name;
                this.description = description;
                this.type = type;
                this.targeting = targeting;
                this.cooldown = cooldown;
                this.resourceCost = resourceCost;
                this.resourceType = resourceType;
                this.level = level;
                this.currentCooldown = 0;
            }

            use(character, target = null) {
                if (this.currentCooldown > 0) return false;
                if (!this.checkResource(character)) return false;

                this.consumeResource(character);
                this.applyEffect(character, target);
                this.currentCooldown = this.cooldown;

                return true;
            }

            checkResource(character) {
                return character.resources[this.resourceType] >= this.resourceCost;
            }

            consumeResource(character) {
                character.resources[this.resourceType] -= this.resourceCost;
            }

            applyEffect(character, target) {
                // Override in subclasses
            }

            update(deltaTime) {
                if (this.currentCooldown > 0) {
                    this.currentCooldown -= deltaTime;
                }
            }
        }

        class OffensiveAbility extends BaseAbility {
            constructor(name, description, damage, targeting, cooldown, resourceCost, resourceType, level = 1) {
                super(name, description, 'offensive', targeting, cooldown, resourceCost, resourceType, level);
                this.damage = damage;
            }

            applyEffect(character, target) {
                if (!target) return;
                let finalDamage = this.damage + (character.stats.attack * 0.5);
                target.takeDamage(finalDamage);
            }
        }

        class DefensiveAbility extends BaseAbility {
            constructor(name, description, defenseBonus, duration, targeting, cooldown, resourceCost, resourceType, level = 1) {
                super(name, description, 'defensive', targeting, cooldown, resourceCost, resourceType, level);
                this.defenseBonus = defenseBonus;
                this.duration = duration;
                this.currentDuration = 0;
            }

            applyEffect(character, target) {
                target = target || character;
                target.stats.defense += this.defenseBonus;
                setTimeout(() => {
                    target.stats.defense -= this.defenseBonus;
                }, this.duration * 1000);
            }
        }

        class UtilityAbility extends BaseAbility {
            constructor(name, description, effect, targeting, cooldown, resourceCost, resourceType, level = 1) {
                super(name, description, 'utility', targeting, cooldown, resourceCost, resourceType, level);
                this.effect = effect;
            }

            applyEffect(character, target) {
                if (this.effect === 'heal') {
                    target.heal(this.resourceCost * 2);
                }
            }
        }

        class AbilityManager {
            constructor(character, game) {
                this.character = character;
                this.game = game;
                this.abilities = [];
            }

            addAbility(ability) {
                this.abilities.push(ability);
            }

            update(deltaTime) {
                this.abilities.forEach(ability => ability.update(deltaTime));
            }

            useAbility(abilityName, target = null) {
                const ability = this.abilities.find(a => a.name === abilityName);
                if (ability && ability.use(this.character, target)) {
                    if (this.game.uiManager) {
                        this.game.uiManager.updateAbilityCooldown(ability);
                    }
                    return true;
                }
                return false;
            }
        }

        // Basic UIManager components
        class UIComponent {
            constructor(x, y, width, height) {
                this.position = { x: x || 0, y: y || 0 };
                this.size = { width: width || 100, height: height || 30 };
                this.visible = true;
                this.enabled = true;
                this.focused = false;
                this.hovered = false;
                this.clicked = false;

                this.style = {
                    backgroundColor: '#333333',
                    borderColor: '#666666',
                    borderWidth: 2,
                    borderRadius: 4,
                    textColor: '#ffffff',
                    font: '16px monospace',
                    padding: 8,
                    margin: 4
                };

                this.parent = null;
                this.children = [];
                this.events = new Map();

                this.animation = null;
                this.dirty = true;
            }

            update(deltaTime) {
                if (!this.visible) return;

                if (this.animation) {
                    this.animation.update(deltaTime);
                }

                this.children.forEach(child => {
                    child.update(deltaTime);
                });
            }

            render(ctx) {
                if (!this.visible) return;

                ctx.save();

                ctx.translate(this.position.x, this.position.y);

                if (this.style.backgroundColor) {
                    ctx.fillStyle = this.style.backgroundColor;
                    if (this.style.borderRadius > 0) {
                        this.roundedRect(ctx, 0, 0, this.size.width, this.size.height, this.style.borderRadius);
                        ctx.fill();
                    } else {
                        ctx.fillRect(0, 0, this.size.width, this.size.height);
                    }
                }

                if (this.style.borderWidth > 0 && this.style.borderColor) {
                    ctx.strokeStyle = this.style.borderColor;
                    ctx.lineWidth = this.style.borderWidth;

                    if (this.style.borderRadius > 0) {
                        this.roundedRect(ctx, 0, 0, this.size.width, this.size.height, this.style.borderRadius);
                        ctx.stroke();
                    } else {
                        ctx.strokeRect(0, 0, this.size.width, this.size.height);
                    }
                }

                this.renderContent(ctx);

                this.children.forEach(child => {
                    child.render(ctx);
                });

                ctx.restore();

                this.dirty = false;
            }

            renderContent(ctx) {
                // Override in subclasses
            }

            roundedRect(ctx, x, y, width, height, radius) {
                ctx.beginPath();
                ctx.moveTo(x + radius, y);
                ctx.lineTo(x + width - radius, y);
                ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
                ctx.lineTo(x + width, y + height - radius);
                ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
                ctx.lineTo(x + radius, y + height);
                ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
                ctx.lineTo(x, y + radius);
                ctx.quadraticCurveTo(x, y, x + radius, y);
                ctx.closePath();
            }

            on(event, callback) {
                if (!this.events.has(event)) {
                    this.events.set(event, []);
                }
                this.events.get(event).push(callback);
            }

            emit(event, data) {
                if (this.events.has(event)) {
                    this.events.get(event).forEach(callback => {
                        callback(data, this);
                    });
                }
            }

            handleInput(inputManager) {
                if (!this.visible || !this.enabled) return false;

                const mouse = inputManager.getMousePosition();
                const bounds = this.getBounds();

                const wasHovered = this.hovered;
                this.hovered = this.pointInBounds(mouse.x, mouse.y, bounds);

                if (this.hovered && !wasHovered) {
                    this.emit('mouseenter');
                } else if (!this.hovered && wasHovered) {
                    this.emit('mouseleave');
                }

                if (this.hovered) {
                    if (inputManager.isMousePressed(0)) {
                        this.clicked = true;
                        this.focused = true;
                        this.emit('mousedown');
                        return true;
                    }

                    if (inputManager.isMouseReleased(0) && this.clicked) {
                        this.clicked = false;
                        this.emit('click');
                        return true;
                    }
                }

                if (inputManager.isMouseReleased(0)) {
                    this.clicked = false;
                }

                return false;
            }

            getBounds() {
                return {
                    x: this.position.x,
                    y: this.position.y,
                    width: this.size.width,
                    height: this.size.height
                };
            }

            pointInBounds(x, y, bounds) {
                return x >= bounds.x && x <= bounds.x + bounds.width &&
                       y >= bounds.y && y <= bounds.y + bounds.height;
            }

            addChild(child) {
                if (!this.children.includes(child)) {
                    this.children.push(child);
                    child.parent = this;
                }
            }

            setStyle(properties) {
                Object.assign(this.style, properties);
                this.dirty = true;
            }

            show() {
                this.visible = true;
            }

            hide() {
                this.visible = false;
            }
        }

        class Button extends UIComponent {
            constructor(x, y, width, height, text = '') {
                super(x, y, width, height);
                this.text = text;
                this.textAlign = 'center';
                this.textBaseline = 'middle';

                this.style = {
                    ...this.style,
                    backgroundColor: '#d62828',
                    borderColor: '#ffd700',
                    borderWidth: 3,
                    borderRadius: 8,
                    textColor: '#ffffff',
                    font: 'bold 16px monospace',
                    hoverBackgroundColor: '#ff0000',
                    clickBackgroundColor: '#8b0000',
                    disabledBackgroundColor: '#444444',
                    disabledTextColor: '#666666'
                };
            }

            renderContent(ctx) {
                let bgColor = this.style.backgroundColor;
                let textColor = this.style.textColor;

                if (!this.enabled) {
                    bgColor = this.style.disabledBackgroundColor;
                    textColor = this.style.disabledTextColor;
                } else if (this.clicked) {
                    bgColor = this.style.clickBackgroundColor;
                } else if (this.hovered) {
                    bgColor = this.style.hoverBackgroundColor;
                }

                if (bgColor !== this.style.backgroundColor) {
                    ctx.fillStyle = bgColor;
                    if (this.style.borderRadius > 0) {
                        this.roundedRect(ctx, 0, 0, this.size.width, this.size.height, this.style.borderRadius);
                        ctx.fill();
                    } else {
                        ctx.fillRect(0, 0, this.size.width, this.size.height);
                    }
                }

                if (this.text) {
                    ctx.fillStyle = textColor;
                    ctx.font = this.style.font;
                    ctx.textAlign = this.textAlign;
                    ctx.textBaseline = this.textBaseline;

                    const textX = this.textAlign === 'center' ? this.size.width / 2 : this.style.padding;
                    const textY = this.textBaseline === 'middle' ? this.size.height / 2 : this.style.padding;

                    ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                    ctx.shadowBlur = 2;
                    ctx.shadowOffsetX = 1;
                    ctx.shadowOffsetY = 1;

                    ctx.fillText(this.text, textX, textY);

                    ctx.shadowColor = 'transparent';
                    ctx.shadowBlur = 0;
                    ctx.shadowOffsetX = 0;
                    ctx.shadowOffsetY = 0;
                }
            }

            setText(text) {
                this.text = text;
                this.dirty = true;
            }
        }

        // Simple Dialog System
        class DialogManager {
            constructor() {
                this.currentDialog = null;
                this.dialogQueue = [];
                this.currentNode = null;
                this.dialogData = new Map();
                this.isActive = false;
                this.dialogBubble = null;
            }

            startDialog(dialogId, context = {}) {
                const dialogTree = this.dialogData.get(dialogId);
                if (!dialogTree) {
                    console.warn(`Dialog ${dialogId} not found`);
                    return;
                }

                this.currentDialog = dialogTree;
                this.context = context;

                if (this.isActive) {
                    this.dialogQueue.push({ dialogId, context });
                    return;
                }

                this.isActive = true;
                this.goToNode('start');
            }

            goToNode(nodeId) {
                const nodes = this.dialogData.get(`${this.currentDialog.id}_nodes`);
                const node = nodes.get(nodeId);

                if (!node) {
                    console.warn(`Node ${nodeId} not found in dialog ${this.currentDialog.id}`);
                    this.endDialog();
                    return;
                }

                this.currentNode = node;

                if (this.dialogBubble) {
                    this.dialogBubble.setDialog(node.text, node.speaker || '');
                }

                if (!node.choices || node.choices.length === 0) {
                    setTimeout(() => this.endDialog(), 2000);
                }
            }

            endDialog() {
                this.isActive = false;
                this.currentDialog = null;
                this.currentNode = null;

                if (this.dialogBubble) {
                    this.dialogBubble.hide();
                }

                if (this.dialogQueue.length > 0) {
                    const next = this.dialogQueue.shift();
                    this.startDialog(next.dialogId, next.context);
                }
            }
        }

        // Make systems available globally for the UI
        window.ParticleSystem = window.ParticleSystem || ParticleSystem;
        window.AnimationManager = window.AnimationManager || AnimationManager;
        window.GameEngine = GameEngine;
        window.Character = Character;
        window.Item = Item;
        window.Weapon = Weapon;
        window.Armor = Armor;
        window.Consumable = Consumable;
        window.InventoryManager = InventoryManager;
        window.OffensiveAbility = OffensiveAbility;
        window.DefensiveAbility = DefensiveAbility;
        window.UtilityAbility = UtilityAbility;
        window.AbilityManager = AbilityManager;
        window.UIComponent = UIComponent;
        window.Button = Button;
        window.DialogManager = DialogManager;
    </script>
    
    <!-- Enhanced Project Manager Integration -->
    <script>
        // Wait for all systems to initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Wait for project manager to initialize
            await new Promise(resolve => {
                const checkManager = () => {
                    if (window.projectManager && window.projectManager.isInitialized !== false) {
                        resolve();
                    } else {
                        setTimeout(checkManager, 100);
                    }
                };
                checkManager();
            });
            
            // Wait for workflow system to initialize
            await new Promise(resolve => {
                const checkWorkflow = () => {
                    if (window.projectWorkflow && window.projectWorkflow.isInitialized) {
                        resolve();
                    } else {
                        setTimeout(checkWorkflow, 100);
                    }
                };
                checkWorkflow();
            });
            
            // Integrate systems
            window.projectWorkflow.setProjectManager(window.projectManager);
            
            // Add workflow buttons to the UI
            addWorkflowButtons();
            
            // Show welcome message with instructions
            showWelcomeMessage();

            // Initialize Game Systems
            await initializeGameSystems();

            // Initialize accessibility features
            initializeAccessibility();

            console.log('üéÆ Complete Project Management System Ready!');
        });

        // Screen reader announcement function
        function announceToScreenReader(message, priority = 'polite') {
            const target = priority === 'assertive' ? 'sr-status' : 'sr-announcements';
            const announcer = document.getElementById(target);
            if (announcer) {
                announcer.textContent = message;
                if (priority === 'assertive') {
                    setTimeout(() => { announcer.textContent = ''; }, 1000);
                }
            }
        }

        // Initialize accessibility features
        function initializeAccessibility() {
            // Announce page load
            setTimeout(() => {
                announceToScreenReader('Project Manager interface loaded. Use Tab to navigate through controls.');
            }, 1000);

            // Add keyboard navigation support for modal dialogs
            document.addEventListener('keydown', (e) => {
                // Escape key handling for modals
                if (e.key === 'Escape') {
                    const activeModal = document.querySelector('.modal[style*="display: flex"]');
                    if (activeModal) {
                        const closeBtn = activeModal.querySelector('[id^="close"]');
                        if (closeBtn) closeBtn.click();
                    }
                }
            });

            // Focus management for dynamic content
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                        const addedElements = Array.from(mutation.addedNodes).filter(node =>
                            node.nodeType === Node.ELEMENT_NODE && node.matches('button, input, select, textarea, [tabindex]')
                        );
                        if (addedElements.length > 0) {
                            announceToScreenReader(`${addedElements.length} new interactive element${addedElements.length > 1 ? 's' : ''} added to the page.`);
                        }
                    }
                });
            });

            observer.observe(document.body, { childList: true, subtree: true });

            // High contrast mode support
            const highContrast = window.matchMedia('(prefers-contrast: high)').matches;
            if (highContrast) {
                document.body.classList.add('high-contrast');
            }

            // Reduced motion support
            const reducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            if (reducedMotion) {
                document.body.classList.add('reduced-motion');
            }
        }

        // Initialize Game Engine Systems
        async function initializeGameSystems() {
            try {
                console.log('üöÄ Initializing Game Engine Systems...');

                // Check if required DOM elements exist
                const canvas = document.getElementById('gamePreviewCanvas');
                if (!canvas) {
                    console.warn('Game preview canvas not found, skipping game engine initialization');
                    return;
                }

                // Initialize Game Engine with canvas
                window.gameEngine = new window.GameEngine('gamePreviewCanvas', {
                    fps: 60,
                    pixelArt: false,
                    responsive: true,
                    audioEnabled: false,
                    touchEnabled: true
                });

                // Guarded initialization of optional core helpers (non-breaking)
                try {
                    if (!window.gameEngine.eventBus && window.EventBus) window.gameEngine.eventBus = new window.EventBus();
                    if (!window.gameEngine.resources && window.ResourceManager) window.gameEngine.resources = new window.ResourceManager();
                    if (!window.gameEngine.renderer && window.Renderer && window.gameEngine.canvas) window.gameEngine.renderer = new window.Renderer(window.gameEngine.canvas);
                    // Announce readiness
                    try { window.gameEngine.emit && window.gameEngine.emit('engineReady', { engine: window.gameEngine }); } catch (e) {}
                    try { window.gameEngine.eventBus && window.gameEngine.eventBus.emit('engine:ready', { engine: window.gameEngine }); } catch (e) {}
                } catch (e) { console.warn('Optional core helpers init failed:', e); }

                // Initialize UI Manager (simplified)
                window.uiManager = {
                    addComponent: function(component) { /* Simplified */ },
                    update: function() { /* Simplified */ },
                    render: function() { /* Simplified */ }
                };

                // Initialize Character System
                window.character = new window.Character({
                    health: 100,
                    maxHealth: 100,
                    mana: 50,
                    maxMana: 50,
                    level: 1,
                    experience: 0,
                    strength: 10,
                    agility: 10,
                    intelligence: 10
                });

                // Initialize Inventory System
                window.inventoryManager = new window.InventoryManager(50);

                // Initialize Ability System
                window.abilityManager = new window.AbilityManager(window.character, window.gameEngine);

                // Initialize Animation Manager
                window.animationManager = new window.AnimationManager(window.gameEngine);

                // Initialize Dialog System
                window.dialogManager = new window.DialogManager(window.uiManager);

                console.log('‚úÖ All Game Systems Initialized Successfully!');

                // Start the game engine
                if (window.gameEngine && typeof window.gameEngine.start === 'function') {
                    window.gameEngine.start();
                }

                // Setup system tabs
                setupSystemTabs();

            } catch (error) {
                console.error('‚ùå Failed to initialize game systems:', error);
                // Continue with partial initialization
                setupSystemTabs();
            }
        }

        // Setup system management tabs
        function setupSystemTabs() {
            try {
                const container = document.querySelector('.container.mx-auto.px-4.py-8');
                if (!container) {
                    console.warn('Container element not found, skipping system tabs setup');
                    return;
                }

                const systemsContainer = document.createElement('div');
                systemsContainer.className = 'mt-8';
                systemsContainer.innerHTML = `
                    <h2 class="text-2xl font-bold mb-4 text-green-400">üéÆ Game Systems Management</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-gray-800 p-6 rounded-lg">
                            <h3 class="text-lg font-bold text-blue-400 mb-3">üë§ Character</h3>
                            <p class="text-gray-300 mb-4">Manage character stats, leveling, and attributes</p>
                            <button id="characterBtn" class="btn-neon w-full">Configure Character</button>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-lg">
                            <h3 class="text-lg font-bold text-purple-400 mb-3">üéí Inventory</h3>
                            <p class="text-gray-300 mb-4">Manage items, equipment, and crafting</p>
                            <button id="inventoryBtn" class="btn-neon w-full">Manage Inventory</button>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-lg">
                            <h3 class="text-lg font-bold text-yellow-400 mb-3">‚ö° Abilities</h3>
                            <p class="text-gray-300 mb-4">Configure powers, hotbar, and magic</p>
                            <button id="abilitiesBtn" class="btn-neon w-full">Setup Abilities</button>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-lg">
                            <h3 class="text-lg font-bold text-pink-400 mb-3">üí¨ Dialog</h3>
                            <p class="text-gray-300 mb-4">Create and edit conversation trees</p>
                            <button id="dialogBtn" class="btn-neon w-full">Edit Dialog</button>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-lg">
                            <h3 class="text-lg font-bold text-red-400 mb-3">üé≠ Animation</h3>
                            <p class="text-gray-300 mb-4">Configure animations and effects</p>
                            <button id="animationBtn" class="btn-neon w-full">Animation Editor</button>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-lg">
                            <h3 class="text-lg font-bold text-cyan-400 mb-3">üñºÔ∏è UI Components</h3>
                            <p class="text-gray-300 mb-4">Design and preview UI elements</p>
                            <button id="uiBtn" class="btn-neon w-full">UI Designer</button>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-lg">
                            <h3 class="text-lg font-bold text-orange-400 mb-3">üéÆ Game Demo</h3>
                            <p class="text-gray-300 mb-4">Interactive game demo with player character</p>
                            <button id="demoBtn" class="btn-neon w-full">Launch Demo</button>
                        </div>
                    </div>
                `;

                container.appendChild(systemsContainer);

                // Add event listeners for system buttons with checks
                const buttons = [
                    { id: 'characterBtn', handler: () => showCharacterPanel() },
                    { id: 'inventoryBtn', handler: () => showInventoryPanel() },
                    { id: 'abilitiesBtn', handler: () => showAbilitiesPanel() },
                    { id: 'dialogBtn', handler: () => showDialogPanel() },
                    { id: 'animationBtn', handler: () => showAnimationPanel() },
                    { id: 'uiBtn', handler: () => showUIPanel() },
                    { id: 'demoBtn', handler: () => showDemoPanel() }
                ];

                buttons.forEach(button => {
                    const element = document.getElementById(button.id);
                    if (element) {
                        element.addEventListener('click', button.handler);
                    }
                });

            } catch (error) {
                console.error('Failed to setup system tabs:', error);
            }
        }

        // System Panel Functions
        function showCharacterPanel() {
            const modal = document.createElement('div');
            modal.className = 'modal fixed inset-0 z-50';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-blue-400">üë§ Character Management</h2>
                        <button id="closeCharacterModal" class="text-2xl text-gray-400 hover:text-white">&times;</button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Character Stats -->
                        <div class="bg-gray-800 p-6 rounded-lg">
                            <h3 class="text-xl font-bold text-green-400 mb-4">Core Stats</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-300">Health:</span>
                                    <span class="text-red-400" id="charHealth">${window.character.health}/${window.character.maxHealth}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-300">Mana:</span>
                                    <span class="text-blue-400" id="charMana">${window.character.mana}/${window.character.maxMana}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-300">Level:</span>
                                    <span class="text-yellow-400" id="charLevel">${window.character.level}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-300">Experience:</span>
                                    <span class="text-purple-400" id="charExp">${window.character.experience}/${window.character.experienceToNext}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Attributes -->
                        <div class="bg-gray-800 p-6 rounded-lg">
                            <h3 class="text-xl font-bold text-yellow-400 mb-4">Attributes</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-300">Strength:</span>
                                    <div class="flex items-center gap-2">
                                        <button class="bg-red-600 px-2 py-1 rounded text-xs" onclick="adjustAttribute('strength', -1)">-</button>
                                        <span class="text-red-400 min-w-[20px] text-center" id="charStrength">${window.character.strength}</span>
                                        <button class="bg-red-600 px-2 py-1 rounded text-xs" onclick="adjustAttribute('strength', 1)">+</button>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-300">Agility:</span>
                                    <div class="flex items-center gap-2">
                                        <button class="bg-green-600 px-2 py-1 rounded text-xs" onclick="adjustAttribute('agility', -1)">-</button>
                                        <span class="text-green-400 min-w-[20px] text-center" id="charAgility">${window.character.agility}</span>
                                        <button class="bg-green-600 px-2 py-1 rounded text-xs" onclick="adjustAttribute('agility', 1)">+</button>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-300">Intelligence:</span>
                                    <div class="flex items-center gap-2">
                                        <button class="bg-blue-600 px-2 py-1 rounded text-xs" onclick="adjustAttribute('intelligence', -1)">-</button>
                                        <span class="text-blue-400 min-w-[20px] text-center" id="charIntelligence">${window.character.intelligence}</span>
                                        <button class="bg-blue-600 px-2 py-1 rounded text-xs" onclick="adjustAttribute('intelligence', 1)">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Combat Stats -->
                        <div class="bg-gray-800 p-6 rounded-lg">
                            <h3 class="text-xl font-bold text-red-400 mb-4">Combat Stats</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-300">Attack Power:</span>
                                    <span class="text-red-400" id="charAttack">${window.character.getAttackPower()}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-300">Defense:</span>
                                    <span class="text-green-400" id="charDefense">${window.character.getDefense()}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-300">Magic Power:</span>
                                    <span class="text-blue-400" id="charMagic">${window.character.getMagicPower()}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-300">Dodge Chance:</span>
                                    <span class="text-yellow-400" id="charDodge">${(window.character.getDodgeChance() * 100).toFixed(1)}%</span>
                                </div>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="bg-gray-800 p-6 rounded-lg">
                            <h3 class="text-xl font-bold text-purple-400 mb-4">Actions</h3>
                            <div class="space-y-3">
                                <button class="btn-neon w-full" onclick="gainExperience(100)">Gain 100 XP</button>
                                <button class="bg-green-600 px-4 py-2 rounded-lg hover:bg-green-500 w-full" onclick="healCharacter(25)">Heal 25 HP</button>
                                <button class="bg-blue-600 px-4 py-2 rounded-lg hover:bg-blue-500 w-full" onclick="restoreMana(15)">Restore 15 MP</button>
                                <button class="bg-red-600 px-4 py-2 rounded-lg hover:bg-red-500 w-full" onclick="takeDamage(20)">Take 20 Damage</button>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-4 mt-6">
                        <button class="btn-neon flex-1" onclick="saveCharacterConfig()">Save Character</button>
                        <button class="bg-gray-600 px-6 py-3 rounded-lg hover:bg-gray-500" onclick="resetCharacter()">Reset to Default</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            document.getElementById('closeCharacterModal').addEventListener('click', () => modal.remove());
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
        }

        // Character helper functions
function adjustAttribute(attr, amount) {
            if (window.character && typeof window.character[attr] === 'number') {
                const newValue = window.character[attr] + amount;
                if (newValue >= 1 && newValue <= 20) {
                    window.character[attr] = newValue;
                    updateCharacterDisplay();
                    try { window.gameEngine?.eventBus?.emit('character:adjust', { attr, amount, value: window.character[attr] }); } catch (e) {}
                }
            }
        }

function gainExperience(amount) {
            if (window.character && typeof window.character.gainExperience === 'function') {
                window.character.gainExperience(amount);
                updateCharacterDisplay();
                try { window.gameEngine?.eventBus?.emit('character:gainXP', { amount, level: window.character.level, exp: window.character.experience }); } catch (e) {}
            } else {
                // Fallback for non-module version
                window.character.experience += amount;
                while (window.character.experience >= window.character.level * 100) {
                    window.character.level++;
                    window.character.maxHealth += 10;
                    window.character.health = window.character.maxHealth;
                }
                updateCharacterDisplay();
            }
        }

function healCharacter(amount) {
            if (window.character && typeof window.character.heal === 'function') {
                window.character.heal(amount);
                updateCharacterDisplay();
                try { window.gameEngine?.eventBus?.emit('character:heal', { amount, health: window.character.health }); } catch (e) {}
            } else {
                // Fallback
                window.character.health = Math.min(window.character.maxHealth, window.character.health + amount);
                updateCharacterDisplay();
            }
        }

function restoreMana(amount) {
            if (window.character && typeof window.character.restoreMana === 'function') {
                window.character.restoreMana(amount);
                updateCharacterDisplay();
                try { window.gameEngine?.eventBus?.emit('character:restoreMana', { amount, mana: window.character.mana }); } catch (e) {}
            } else {
                // Fallback
                window.character.mana = Math.min(window.character.maxMana, window.character.mana + amount);
                updateCharacterDisplay();
            }
        }

function takeDamage(amount) {
            if (window.character && typeof window.character.takeDamage === 'function') {
                window.character.takeDamage(amount);
                updateCharacterDisplay();
                try { window.gameEngine?.eventBus?.emit('character:damage', { amount, health: window.character.health }); } catch (e) {}
            } else {
                // Fallback
                window.character.health -= amount;
                if (window.character.health <= 0) window.character.health = 0;
                updateCharacterDisplay();
            }
        }

        function updateCharacterDisplay() {
            if (!window.character) return;

            const elements = ['charHealth', 'charMana', 'charLevel', 'charExp', 'charStrength', 'charAgility', 'charIntelligence', 'charAttack', 'charDefense', 'charMagic', 'charDodge'];
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    try {
                        switch(id) {
                            case 'charHealth': element.textContent = `${window.character.health || 0}/${window.character.maxHealth || 100}`; break;
                            case 'charMana': element.textContent = `${window.character.mana || 0}/${window.character.maxMana || 50}`; break;
                            case 'charLevel': element.textContent = window.character.level || 1; break;
                            case 'charExp':
                                const exp = window.character.experience || 0;
                                const nextExp = window.character.experienceToNext || (window.character.level || 1) * 100;
                                element.textContent = `${exp}/${nextExp}`;
                                break;
                            case 'charStrength': element.textContent = window.character.strength || 10; break;
                            case 'charAgility': element.textContent = window.character.agility || 10; break;
                            case 'charIntelligence': element.textContent = window.character.intelligence || 10; break;
                            case 'charAttack':
                                if (typeof window.character.getAttackPower === 'function') {
                                    element.textContent = window.character.getAttackPower();
                                } else {
                                    element.textContent = ((window.character.strength || 10) * 2) + (window.character.level || 1);
                                }
                                break;
                            case 'charDefense':
                                if (typeof window.character.getDefense === 'function') {
                                    element.textContent = window.character.getDefense();
                                } else {
                                    element.textContent = (window.character.agility || 10) + (window.character.level || 1);
                                }
                                break;
                            case 'charMagic':
                                if (typeof window.character.getMagicPower === 'function') {
                                    element.textContent = window.character.getMagicPower();
                                } else {
                                    element.textContent = ((window.character.intelligence || 10) * 1.5) + (window.character.level || 1);
                                }
                                break;
                            case 'charDodge':
                                if (typeof window.character.getDodgeChance === 'function') {
                                    element.textContent = `${(window.character.getDodgeChance() * 100).toFixed(1)}%`;
                                } else {
                                    element.textContent = `${Math.min(50, (window.character.agility || 10) * 0.1)}%`;
                                }
                                break;
                        }
                    } catch (error) {
                        console.warn(`Failed to update character display element ${id}:`, error);
                        // Fallback values
                        switch(id) {
                            case 'charHealth': element.textContent = '100/100'; break;
                            case 'charMana': element.textContent = '50/50'; break;
                            case 'charLevel': element.textContent = '1'; break;
                            default: element.textContent = 'N/A'; break;
                        }
                    }
                }
            });
        }

        function saveCharacterConfig() {
            const config = {
                health: window.character.health,
                maxHealth: window.character.maxHealth,
                mana: window.character.mana,
                maxMana: window.character.maxMana,
                level: window.character.level,
                experience: window.character.experience,
                strength: window.character.strength,
                agility: window.character.agility,
                intelligence: window.character.intelligence
            };
            localStorage.setItem('characterConfig', JSON.stringify(config));
            showNotification('Character configuration saved!', 'success');
        }

        function resetCharacter() {
            Object.assign(window.character, {
                health: 100,
                maxHealth: 100,
                mana: 50,
                maxMana: 50,
                level: 1,
                experience: 0,
                strength: 10,
                agility: 10,
                intelligence: 10
            });
            window.character.experienceToNext = window.character.calculateExpToNext();
            updateCharacterDisplay();
            showNotification('Character reset to default!', 'info');
        }

        // Other System Panels
        function showInventoryPanel() {
            const modal = document.createElement('div');
            modal.className = 'modal fixed inset-0 z-50';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content max-w-6xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-purple-400">üéí Inventory Management</h2>
                        <button id="closeInventoryModal" class="text-2xl text-gray-400 hover:text-white">&times;</button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Inventory Grid -->
                        <div class="bg-gray-800 p-6 rounded-lg">
                            <h3 class="text-xl font-bold text-green-400 mb-4">Inventory (${window.inventoryManager.inventory.size}/${window.inventoryManager.capacity})</h3>
                            <div id="inventoryGrid" class="grid grid-cols-5 gap-2 mb-4">
                                <!-- Inventory slots will be populated here -->
                            </div>
                            <button class="btn-neon w-full" onclick="addRandomItem()">Add Random Item</button>
                        </div>

                        <!-- Equipment Slots -->
                        <div class="bg-gray-800 p-6 rounded-lg">
                            <h3 class="text-xl font-bold text-yellow-400 mb-4">Equipment</h3>
                            <div class="space-y-3">
                                <div class="flex items-center gap-3">
                                    <span class="text-gray-300 w-20">Helmet:</span>
                                    <div id="helmetSlot" class="w-12 h-12 bg-gray-700 border border-gray-600 rounded flex items-center justify-center text-xs">Empty</div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="text-gray-300 w-20">Chest:</span>
                                    <div id="chestSlot" class="w-12 h-12 bg-gray-700 border border-gray-600 rounded flex items-center justify-center text-xs">Empty</div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="text-gray-300 w-20">Weapon:</span>
                                    <div id="weaponSlot" class="w-12 h-12 bg-gray-700 border border-gray-600 rounded flex items-center justify-center text-xs">Empty</div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="text-gray-300 w-20">Boots:</span>
                                    <div id="bootsSlot" class="w-12 h-12 bg-gray-700 border border-gray-600 rounded flex items-center justify-center text-xs">Empty</div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="text-gray-300 w-20">Gloves:</span>
                                    <div id="glovesSlot" class="w-12 h-12 bg-gray-700 border border-gray-600 rounded flex items-center justify-center text-xs">Empty</div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="text-gray-300 w-20">Amulet:</span>
                                    <div id="amuletSlot" class="w-12 h-12 bg-gray-700 border border-gray-600 rounded flex items-center justify-center text-xs">Empty</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Item Details -->
                    <div class="bg-gray-800 p-6 rounded-lg mt-6">
                        <h3 class="text-xl font-bold text-blue-400 mb-4">Item Details</h3>
                        <div id="itemDetails" class="text-gray-300">
                            Select an item to view details
                        </div>
                    </div>

                    <div class="flex gap-4 mt-6">
                        <button class="btn-neon flex-1" onclick="saveInventoryConfig()">Save Inventory</button>
                        <button class="bg-red-600 px-6 py-3 rounded-lg hover:bg-red-500" onclick="clearInventory()">Clear All</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            updateInventoryDisplay();

            document.getElementById('closeInventoryModal').addEventListener('click', () => modal.remove());
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
        }

        function updateInventoryDisplay() {
            const grid = document.getElementById('inventoryGrid');
            if (!grid) return;

            grid.innerHTML = '';
            for (let i = 0; i < window.inventoryManager.capacity; i++) {
                const item = window.inventoryManager.inventory.get(i);
                const slot = document.createElement('div');
                slot.className = 'w-12 h-12 bg-gray-700 border border-gray-600 rounded flex items-center justify-center text-xs cursor-pointer hover:bg-gray-600';
                slot.textContent = item ? (item.quantity > 1 ? item.quantity : item.name.charAt(0)) : '';
                slot.onclick = () => showItemDetails(item, i);
                grid.appendChild(slot);
            }

            // Update equipment slots
            const equipmentSlots = ['helmet', 'chest', 'weapon', 'boots', 'gloves', 'amulet'];
            equipmentSlots.forEach(slot => {
                const element = document.getElementById(`${slot}Slot`);
                const item = window.inventoryManager.equipmentSlots[slot];
                if (element) {
                    element.textContent = item ? item.name.charAt(0) : 'Empty';
                    element.className = item ?
                        'w-12 h-12 bg-yellow-600 border border-yellow-400 rounded flex items-center justify-center text-xs cursor-pointer' :
                        'w-12 h-12 bg-gray-700 border border-gray-600 rounded flex items-center justify-center text-xs';
                }
            });
        }

        function addRandomItem() {
            if (!window.inventoryManager) {
                console.warn('Inventory manager not available');
                return;
            }

            try {
                const items = [
                    new window.Item(1, 'Health Potion', 'Restores 50 HP', 'common', 25, true, 5),
                    new window.Weapon(2, 'Iron Sword', 'A sturdy blade', 15, 'sword', 'common', 100),
                    new window.Armor(3, 'Leather Armor', 'Basic protection', 8, 'light', 'chest', 'common', 75),
                    new window.Item(4, 'Mana Crystal', 'Restores 30 MP', 'rare', 50, true, 3)
                ];
                const randomItem = items[Math.floor(Math.random() * items.length)];

                if (window.inventoryManager.addItem && typeof window.inventoryManager.addItem === 'function') {
                    window.inventoryManager.addItem(randomItem);
                } else {
                    // Fallback for non-module version
                    const slot = window.inventoryManager.findEmptySlot ? window.inventoryManager.findEmptySlot() : 0;
                    if (slot !== null) {
                        window.inventoryManager.inventory.set(slot, randomItem);
                    }
                }
                updateInventoryDisplay();
            } catch (error) {
                console.warn('Failed to add random item:', error);
            }
        }

        function showItemDetails(item, slot) {
            const details = document.getElementById('itemDetails');
            if (!details) return;

            if (item) {
                details.innerHTML = `
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <h4 class="text-lg font-bold text-${item.rarity === 'rare' ? 'blue' : item.rarity === 'epic' ? 'purple' : 'gray'}-400">${item.name}</h4>
                            <p class="text-sm text-gray-400 mb-2">${item.description}</p>
                            <p class="text-sm">Rarity: <span class="text-${item.rarity === 'rare' ? 'blue' : item.rarity === 'epic' ? 'purple' : 'gray'}-400">${item.rarity}</span></p>
                            <p class="text-sm">Value: <span class="text-yellow-400">${item.value} gold</span></p>
                            ${item.quantity ? `<p class="text-sm">Quantity: <span class="text-green-400">${item.quantity}</span></p>` : ''}
                        </div>
                        <div>
                            <button class="btn-neon w-full mb-2" onclick="useItem(${slot})">Use Item</button>
                            <button class="bg-blue-600 px-4 py-2 rounded w-full mb-2" onclick="equipItem(${slot})">Equip</button>
                            <button class="bg-red-600 px-4 py-2 rounded w-full" onclick="dropItem(${slot})">Drop Item</button>
                        </div>
                    </div>
                `;
            } else {
                details.innerHTML = 'Select an item to view details';
            }
        }

        function useItem(slot) {
            const item = window.inventoryManager.inventory.get(slot);
            if (item && item.use) {
                item.use(window.character);
                if (item.quantity <= 0) {
                    window.inventoryManager.inventory.delete(slot);
                }
                updateInventoryDisplay();
                showNotification(`Used ${item.name}!`, 'success');
            }
        }

        function equipItem(slot) {
            // This would need more sophisticated logic for equipment slots
            showNotification('Equipment system ready for implementation!', 'info');
        }

        function dropItem(slot) {
            window.inventoryManager.inventory.delete(slot);
            updateInventoryDisplay();
            showNotification('Item dropped!', 'warning');
        }

        function saveInventoryConfig() {
            const config = {
                capacity: window.inventoryManager.capacity,
                inventory: Array.from(window.inventoryManager.inventory.entries()),
                equipmentSlots: window.inventoryManager.equipmentSlots
            };
            localStorage.setItem('inventoryConfig', JSON.stringify(config));
            showNotification('Inventory configuration saved!', 'success');
        }

        function clearInventory() {
            window.inventoryManager.inventory.clear();
            Object.keys(window.inventoryManager.equipmentSlots).forEach(slot => {
                window.inventoryManager.equipmentSlots[slot] = null;
            });
            updateInventoryDisplay();
            showNotification('Inventory cleared!', 'warning');
        }

        function showAbilitiesPanel() {
            const modal = document.createElement('div');
            modal.className = 'modal fixed inset-0 z-50';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content max-w-6xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-yellow-400">‚ö° Ability Management</h2>
                        <button id="closeAbilitiesModal" class="text-2xl text-gray-400 hover:text-white">&times;</button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Available Abilities -->
                        <div class="bg-gray-800 p-6 rounded-lg">
                            <h3 class="text-xl font-bold text-green-400 mb-4">Available Abilities</h3>
                            <div id="abilitiesList" class="space-y-2 mb-4">
                                <!-- Abilities will be populated here -->
                            </div>
                            <button class="btn-neon w-full" onclick="addSampleAbilities()">Add Sample Abilities</button>
                        </div>

                        <!-- Hotbar -->
                        <div class="bg-gray-800 p-6 rounded-lg">
                            <h3 class="text-xl font-bold text-red-400 mb-4">Ability Hotbar</h3>
                            <div id="hotbarSlots" class="grid grid-cols-4 gap-2 mb-4">
                                <!-- Hotbar slots will be populated here -->
                            </div>
                            <div class="text-sm text-gray-400">
                                <p>Click abilities to assign to hotbar slots</p>
                                <p>Right-click hotbar slots to clear</p>
                            </div>
                        </div>
                    </div>

                    <!-- Resource Management -->
                    <div class="bg-gray-800 p-6 rounded-lg mt-6">
                        <h3 class="text-xl font-bold text-blue-400 mb-4">Resources</h3>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-red-400" id="resourceMana">${window.character.mana || 0}</div>
                                <div class="text-sm text-gray-400">Mana</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-green-400" id="resourceEnergy">100</div>
                                <div class="text-sm text-gray-400">Energy</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-purple-400" id="resourceFocus">50</div>
                                <div class="text-sm text-gray-400">Focus</div>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-4 mt-6">
                        <button class="btn-neon flex-1" onclick="saveAbilitiesConfig()">Save Abilities</button>
                        <button class="bg-red-600 px-6 py-3 rounded-lg hover:bg-red-500" onclick="clearAbilities()">Clear All</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            updateAbilitiesDisplay();

            document.getElementById('closeAbilitiesModal').addEventListener('click', () => modal.remove());
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
        }

        function updateAbilitiesDisplay() {
            const list = document.getElementById('abilitiesList');
            const hotbar = document.getElementById('hotbarSlots');

            if (list) {
                list.innerHTML = '';
                window.abilityManager.abilities.forEach((ability, index) => {
                    const item = document.createElement('div');
                    item.className = 'p-3 bg-gray-700 rounded cursor-pointer hover:bg-gray-600 flex justify-between items-center';
                    item.innerHTML = `
                        <div>
                            <div class="font-bold text-${ability.type === 'offensive' ? 'red' : ability.type === 'defensive' ? 'green' : 'blue'}-400">${ability.name}</div>
                            <div class="text-sm text-gray-400">${ability.description}</div>
                            <div class="text-xs text-gray-500">Cost: ${ability.resourceCost} ${ability.resourceType}</div>
                        </div>
                        <button class="bg-blue-600 px-3 py-1 rounded text-xs" onclick="assignToHotbar(${index})">Assign</button>
                    `;
                    list.appendChild(item);
                });
            }

            if (hotbar) {
                hotbar.innerHTML = '';
                for (let i = 0; i < 8; i++) {
                    const slot = document.createElement('div');
                    const ability = window.abilityManager.hotbar.slots[i];
                    slot.className = 'w-16 h-16 bg-gray-700 border border-gray-600 rounded flex items-center justify-center text-xs cursor-pointer hover:bg-gray-600';
                    slot.textContent = ability ? ability.name.charAt(0).toUpperCase() : (i + 1).toString();
                    slot.onclick = () => useHotbarAbility(i);
                    slot.oncontextmenu = (e) => { e.preventDefault(); clearHotbarSlot(i); };
                    hotbar.appendChild(slot);
                }
            }
        }

        function addSampleAbilities() {
            const abilities = [
                new window.OffensiveAbility('Fire Bolt', 'Hurls a bolt of fire', 25, 'single', 2.0, 15, 'mana'),
                new window.DefensiveAbility('Shield Wall', 'Creates a protective barrier', 10, 5.0, 'self', 3.0, 20, 'mana'),
                new window.UtilityAbility('Heal', 'Restores health', 30, 'self', 2.5, 25, 'mana')
            ];

            abilities.forEach(ability => window.abilityManager.addAbility(ability));
            updateAbilitiesDisplay();
            showNotification('Sample abilities added!', 'success');
        }

        function assignToHotbar(abilityIndex) {
            const ability = window.abilityManager.abilities[abilityIndex];
            if (ability) {
                // Find first empty slot or replace current selection
                let slotIndex = -1;
                for (let i = 0; i < 8; i++) {
                    if (!window.abilityManager.hotbar.slots[i]) {
                        slotIndex = i;
                        break;
                    }
                }
                if (slotIndex >= 0) {
                    window.abilityManager.hotbar.assignAbility(slotIndex, ability);
                    updateAbilitiesDisplay();
                    showNotification(`Assigned ${ability.name} to slot ${slotIndex + 1}!`, 'success');
                } else {
                    showNotification('No empty hotbar slots available!', 'warning');
                }
            }
        }

        function useHotbarAbility(slotIndex) {
            window.abilityManager.hotbar.useAbility(slotIndex, window.character, null);
            updateAbilitiesDisplay();
        }

        function clearHotbarSlot(slotIndex) {
            window.abilityManager.hotbar.slots[slotIndex] = null;
            updateAbilitiesDisplay();
        }

        function saveAbilitiesConfig() {
            const config = {
                abilities: window.abilityManager.abilities.map(ability => ({
                    name: ability.name,
                    description: ability.description,
                    type: ability.type,
                    resourceCost: ability.resourceCost,
                    resourceType: ability.resourceType,
                    cooldown: ability.cooldown
                })),
                hotbar: window.abilityManager.hotbar.slots.map(slot => slot ? slot.name : null)
            };
            localStorage.setItem('abilitiesConfig', JSON.stringify(config));
            showNotification('Abilities configuration saved!', 'success');
        }

        function clearAbilities() {
            window.abilityManager.abilities = [];
            window.abilityManager.hotbar.slots.fill(null);
            updateAbilitiesDisplay();
            showNotification('Abilities cleared!', 'warning');
        }

        function showDialogPanel() {
            const modal = document.createElement('div');
            modal.className = 'modal fixed inset-0 z-50';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content max-w-6xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-pink-400">üí¨ Dialog Management</h2>
                        <button id="closeDialogModal" class="text-2xl text-gray-400 hover:text-white">&times;</button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Dialog Editor -->
                        <div class="bg-gray-800 p-6 rounded-lg">
                            <h3 class="text-xl font-bold text-green-400 mb-4">Dialog Editor</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-bold mb-2 text-blue-400">Speaker</label>
                                    <input type="text" id="dialogSpeaker" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white" placeholder="Character name">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold mb-2 text-blue-400">Dialog Text</label>
                                    <textarea id="dialogText" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white h-24" placeholder="Enter dialog text..."></textarea>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-bold mb-2 text-blue-400">Choice 1</label>
                                        <input type="text" id="dialogChoice1" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white" placeholder="Choice text">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold mb-2 text-blue-400">Choice 2</label>
                                        <input type="text" id="dialogChoice2" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white" placeholder="Choice text">
                                    </div>
                                </div>
                                <button class="btn-neon w-full" onclick="addDialogNode()">Add Dialog Node</button>
                            </div>
                        </div>

                        <!-- Dialog Preview -->
                        <div class="bg-gray-800 p-6 rounded-lg">
                            <h3 class="text-xl font-bold text-yellow-400 mb-4">Dialog Preview</h3>
                            <div id="dialogPreview" class="bg-black p-4 rounded-lg min-h-[200px] flex items-center justify-center text-gray-400">
                                Create a dialog node to preview
                            </div>
                            <div class="mt-4 space-y-2">
                                <button class="btn-neon w-full" onclick="startDialogPreview()">Start Preview</button>
                                <button class="bg-gray-600 px-4 py-2 rounded w-full" onclick="clearDialogPreview()">Clear</button>
                            </div>
                        </div>
                    </div>

                    <!-- Dialog Tree -->
                    <div class="bg-gray-800 p-6 rounded-lg mt-6">
                        <h3 class="text-xl font-bold text-purple-400 mb-4">Dialog Tree</h3>
                        <div id="dialogTree" class="text-gray-300">
                            No dialog nodes created yet
                        </div>
                    </div>

                    <div class="flex gap-4 mt-6">
                        <button class="btn-neon flex-1" onclick="saveDialogConfig()">Save Dialog Tree</button>
                        <button class="bg-red-600 px-6 py-3 rounded-lg hover:bg-red-500" onclick="clearDialogTree()">Clear Tree</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            document.getElementById('closeDialogModal').addEventListener('click', () => modal.remove());
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
        }

        function addDialogNode() {
            const speaker = document.getElementById('dialogSpeaker').value;
            const text = document.getElementById('dialogText').value;
            const choice1 = document.getElementById('dialogChoice1').value;
            const choice2 = document.getElementById('dialogChoice2').value;

            if (!text.trim()) {
                showNotification('Please enter dialog text!', 'warning');
                return;
            }

            const nodeId = 'node_' + Date.now();
            const node = {
                id: nodeId,
                text: text,
                speaker: speaker || 'Narrator',
                choices: []
            };

            if (choice1.trim()) {
                node.choices.push({ text: choice1, goto: 'end' });
            }
            if (choice2.trim()) {
                node.choices.push({ text: choice2, goto: 'end' });
            }

            // Store in dialog manager
            if (!window.dialogNodes) window.dialogNodes = new Map();
            window.dialogNodes.set(nodeId, node);

            updateDialogTree();
            showNotification('Dialog node added!', 'success');

            // Clear form
            document.getElementById('dialogSpeaker').value = '';
            document.getElementById('dialogText').value = '';
            document.getElementById('dialogChoice1').value = '';
            document.getElementById('dialogChoice2').value = '';
        }

        function updateDialogTree() {
            const tree = document.getElementById('dialogTree');
            if (!tree || !window.dialogNodes) return;

            tree.innerHTML = '';
            window.dialogNodes.forEach((node, id) => {
                const nodeElement = document.createElement('div');
                nodeElement.className = 'p-3 bg-gray-700 rounded mb-2';
                nodeElement.innerHTML = `
                    <div class="font-bold text-green-400">${node.speaker}</div>
                    <div class="text-sm text-gray-300">${node.text}</div>
                    ${node.choices.length > 0 ? `<div class="text-xs text-blue-400 mt-1">Choices: ${node.choices.length}</div>` : ''}
                `;
                tree.appendChild(nodeElement);
            });
        }

        function startDialogPreview() {
            const preview = document.getElementById('dialogPreview');
            if (!window.dialogNodes || window.dialogNodes.size === 0) {
                preview.innerHTML = '<div class="text-center text-gray-400">No dialog nodes to preview</div>';
                return;
            }

            const firstNode = Array.from(window.dialogNodes.values())[0];
            preview.innerHTML = `
                <div class="bg-gray-700 p-4 rounded-lg">
                    <div class="font-bold text-yellow-400 mb-2">${firstNode.speaker}:</div>
                    <div class="text-white mb-4">${firstNode.text}</div>
                    ${firstNode.choices.length > 0 ? `
                        <div class="space-y-2">
                            ${firstNode.choices.map((choice, index) =>
                                `<button class="block w-full text-left p-2 bg-blue-600 rounded hover:bg-blue-500">${choice.text}</button>`
                            ).join('')}
                        </div>
                    ` : '<div class="text-gray-400 text-sm">End of dialog</div>'}
                </div>
            `;
        }

        function clearDialogPreview() {
            document.getElementById('dialogPreview').innerHTML = '<div class="text-center text-gray-400">Create a dialog node to preview</div>';
        }

        function saveDialogConfig() {
            if (!window.dialogNodes) {
                showNotification('No dialog to save!', 'warning');
                return;
            }
            const config = {
                nodes: Array.from(window.dialogNodes.entries())
            };
            localStorage.setItem('dialogConfig', JSON.stringify(config));
            showNotification('Dialog configuration saved!', 'success');
        }

        function clearDialogTree() {
            if (window.dialogNodes) {
                window.dialogNodes.clear();
                updateDialogTree();
                clearDialogPreview();
                showNotification('Dialog tree cleared!', 'warning');
            }
        }

        function showAnimationPanel() {
            const modal = document.createElement('div');
            modal.className = 'modal fixed inset-0 z-50';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content max-w-6xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-red-400">üé≠ Animation Management</h2>
                        <button id="closeAnimationModal" class="text-2xl text-gray-400 hover:text-white">&times;</button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Animation Controls -->
                        <div class="bg-gray-800 p-6 rounded-lg">
                            <h3 class="text-xl font-bold text-green-400 mb-4">Animation Controls</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-bold mb-2 text-blue-400">Target Element</label>
                                    <select id="animationTarget" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white">
                                        <option value="preview">Preview Canvas</option>
                                        <option value="modal">Modal Content</option>
                                        <option value="button">Test Button</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold mb-2 text-blue-400">Animation Type</label>
                                    <select id="animationType" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white">
                                        <option value="fadeIn">Fade In</option>
                                        <option value="fadeOut">Fade Out</option>
                                        <option value="slideIn">Slide In</option>
                                        <option value="slideOut">Slide Out</option>
                                        <option value="scale">Scale</option>
                                        <option value="pulse">Pulse</option>
                                        <option value="shake">Shake</option>
                                        <option value="bounce">Bounce</option>
                                    </select>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-bold mb-2 text-blue-400">Duration (ms)</label>
                                        <input type="number" id="animationDuration" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white" value="1000">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold mb-2 text-blue-400">Direction</label>
                                        <select id="animationDirection" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white">
                                            <option value="left">Left</option>
                                            <option value="right">Right</option>
                                            <option value="up">Up</option>
                                            <option value="down">Down</option>
                                        </select>
                                    </div>
                                </div>
                                <button class="btn-neon w-full" onclick="playAnimation()">Play Animation</button>
                            </div>
                        </div>

                        <!-- Animation Preview -->
                        <div class="bg-gray-800 p-6 rounded-lg">
                            <h3 class="text-xl font-bold text-yellow-400 mb-4">Animation Preview</h3>
                            <div id="animationPreview" class="bg-black p-8 rounded-lg min-h-[200px] flex items-center justify-center">
                                <div id="previewElement" class="w-16 h-16 bg-neon-pink rounded-lg flex items-center justify-center text-white font-bold">
                                    üéØ
                                </div>
                            </div>
                            <div class="mt-4 text-sm text-gray-400 text-center">
                                Preview area for animations
                            </div>
                        </div>
                    </div>

                    <!-- Performance Stats -->
                    <div class="bg-gray-800 p-6 rounded-lg mt-6">
                        <h3 class="text-xl font-bold text-purple-400 mb-4">Animation Performance</h3>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-green-400" id="activeTweens">0</div>
                                <div class="text-sm text-gray-400">Active Tweens</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-blue-400" id="fps">0</div>
                                <div class="text-sm text-gray-400">FPS</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-yellow-400" id="frameTime">0</div>
                                <div class="text-sm text-gray-400">Frame Time (ms)</div>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-4 mt-6">
                        <button class="btn-neon flex-1" onclick="saveAnimationConfig()">Save Animation Settings</button>
                        <button class="bg-red-600 px-6 py-3 rounded-lg hover:bg-red-500" onclick="killAllAnimations()">Kill All Animations</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Update performance stats
            updateAnimationStats();

            document.getElementById('closeAnimationModal').addEventListener('click', () => modal.remove());
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
        }

        function updateAnimationStats() {
            setInterval(() => {
                const activeTweens = document.getElementById('activeTweens');
                const fps = document.getElementById('fps');
                const frameTime = document.getElementById('frameTime');

                if (activeTweens) activeTweens.textContent = window.animationManager ? window.animationManager.tweens.length : 0;
                if (fps && window.gameEngine) fps.textContent = window.gameEngine.performance.fps;
                if (frameTime && window.gameEngine) frameTime.textContent = window.gameEngine.performance.frameTime.toFixed(2);
            }, 1000);
        }

        function playAnimation() {
            const target = document.getElementById('animationTarget').value;
            const type = document.getElementById('animationType').value;
            const duration = parseInt(document.getElementById('animationDuration').value) || 1000;
            const direction = document.getElementById('animationDirection').value;

            let element;
            switch(target) {
                case 'preview':
                    element = document.getElementById('previewElement');
                    break;
                case 'modal':
                    element = document.querySelector('.modal-content');
                    break;
                case 'button':
                    element = document.querySelector('.btn-neon');
                    break;
                default:
                    element = document.getElementById('previewElement');
            }

            if (!element) return;

            // Create animation object for DOM element
            const animElement = { style: element.style };

            // Add transform properties
            Object.defineProperty(animElement, 'position', {
                get: () => ({ x: 0, y: 0 }),
                set: (value) => {
                    element.style.transform = `translate(${value.x || 0}px, ${value.y || 0}px)`;
                }
            });

            Object.defineProperty(animElement, 'scale', {
                get: () => ({ x: 1, y: 1 }),
                set: (value) => {
                    element.style.transform = `scale(${value.x || 1}, ${value.y || 1})`;
                }
            });

            Object.defineProperty(animElement, 'alpha', {
                get: () => parseFloat(element.style.opacity) || 1,
                set: (value) => {
                    element.style.opacity = value;
                }
            });

            try {
                switch(type) {
                    case 'fadeIn':
                        window.animationManager.fadeIn(animElement, duration);
                        break;
                    case 'fadeOut':
                        window.animationManager.fadeOut(animElement, duration);
                        break;
                    case 'slideIn':
                        window.animationManager.slideIn(animElement, direction, 100, duration);
                        break;
                    case 'slideOut':
                        window.animationManager.slideOut(animElement, direction, 100, duration);
                        break;
                    case 'scale':
                        window.animationManager.scale(animElement, 0, 1, duration);
                        break;
                    case 'pulse':
                        window.animationManager.pulse(animElement, 0.8, 1.2, duration);
                        break;
                    case 'shake':
                        window.animationManager.shake(animElement, 10, duration);
                        break;
                    case 'bounce':
                        window.animationManager.bounce(animElement, 50, duration);
                        break;
                }
                showNotification(`Playing ${type} animation!`, 'success');
            } catch (error) {
                console.error('Animation error:', error);
                showNotification('Animation failed to play!', 'error');
            }
        }

        function saveAnimationConfig() {
            const config = {
                target: document.getElementById('animationTarget').value,
                type: document.getElementById('animationType').value,
                duration: document.getElementById('animationDuration').value,
                direction: document.getElementById('animationDirection').value
            };
            localStorage.setItem('animationConfig', JSON.stringify(config));
            showNotification('Animation settings saved!', 'success');
        }

        function killAllAnimations() {
            if (window.animationManager) {
                window.animationManager.killAll();
                showNotification('All animations killed!', 'warning');
            }
        }

        function showUIPanel() {
            const modal = document.createElement('div');
            modal.className = 'modal fixed inset-0 z-50';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content max-w-6xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-cyan-400">üñºÔ∏è UI Components</h2>
                        <button id="closeUIModal" class="text-2xl text-gray-400 hover:text-white">&times;</button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Component Library -->
                        <div class="bg-gray-800 p-6 rounded-lg">
                            <h3 class="text-xl font-bold text-green-400 mb-4">Component Library</h3>
                            <div class="space-y-3">
                                <button class="btn-neon w-full text-left" onclick="addUIButton()">Add Button</button>
                                <button class="btn-neon w-full text-left" onclick="addUILabel()">Add Label</button>
                                <button class="btn-neon w-full text-left" onclick="addUIProgressBar()">Add Progress Bar</button>
                                <button class="btn-neon w-full text-left" onclick="addUIPanel()">Add Panel</button>
                                <button class="btn-neon w-full text-left" onclick="addUIInputField()">Add Input Field</button>
                            </div>
                        </div>

                        <!-- UI Preview -->
                        <div class="bg-gray-800 p-6 rounded-lg">
                            <h3 class="text-xl font-bold text-yellow-400 mb-4">UI Preview Canvas</h3>
                            <div id="uiPreview" class="bg-black p-4 rounded-lg min-h-[300px] relative overflow-hidden">
                                <div class="text-gray-400 text-center py-16">Add UI components to preview</div>
                            </div>
                            <div class="mt-4 flex gap-2">
                                <button class="btn-neon flex-1" onclick="clearUIPreview()">Clear</button>
                                <button class="bg-blue-600 px-4 py-2 rounded" onclick="exportUI()">Export UI</button>
                            </div>
                        </div>
                    </div>

                    <!-- Theme Settings -->
                    <div class="bg-gray-800 p-6 rounded-lg mt-6">
                        <h3 class="text-xl font-bold text-purple-400 mb-4">Theme Settings</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <button class="p-4 bg-gray-700 rounded-lg hover:bg-gray-600 text-center" onclick="setUITheme('default')">
                                <div class="text-lg mb-2">üé®</div>
                                <div class="text-sm">Default</div>
                            </button>
                            <button class="p-4 bg-gray-700 rounded-lg hover:bg-gray-600 text-center" onclick="setUITheme('neon')">
                                <div class="text-lg mb-2">üí°</div>
                                <div class="text-sm">Neon</div>
                            </button>
                            <button class="p-4 bg-gray-700 rounded-lg hover:bg-gray-600 text-center" onclick="setUITheme('retro')">
                                <div class="text-lg mb-2">üïπÔ∏è</div>
                                <div class="text-sm">Retro</div>
                            </button>
                            <button class="p-4 bg-gray-700 rounded-lg hover:bg-gray-600 text-center" onclick="setUITheme('dark')">
                                <div class="text-lg mb-2">üåô</div>
                                <div class="text-sm">Dark</div>
                            </button>
                        </div>
                    </div>

                    <div class="flex gap-4 mt-6">
                        <button class="btn-neon flex-1" onclick="saveUIConfig()">Save UI Configuration</button>
                        <button class="bg-red-600 px-6 py-3 rounded-lg hover:bg-red-500" onclick="resetUI()">Reset UI</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            document.getElementById('closeUIModal').addEventListener('click', () => modal.remove());
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
        }

        function showDemoPanel() {
            const modal = document.createElement('div');
            modal.className = 'modal fixed inset-0 z-50';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content max-w-7xl w-full max-h-[95vh] overflow-hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-orange-400">üéÆ Game Demo</h2>
                        <button id="closeDemoModal" class="text-2xl text-gray-400 hover:text-white">&times;</button>
                    </div>

                    <div class="grid grid-cols-1 xl:grid-cols-4 gap-6 h-[80vh]">
                        <!-- Main Game Canvas -->
                        <div class="xl:col-span-3 bg-gray-900 rounded-lg p-4">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-green-400">Game Canvas</h3>
                                <div class="flex gap-2">
                                    <button id="startDemoBtn" class="btn-neon text-sm px-3 py-1">‚ñ∂Ô∏è Start</button>
                                    <button id="stopDemoBtn" class="btn-neon text-sm px-3 py-1" disabled>‚èπÔ∏è Stop</button>
                                    <button id="restartDemoBtn" class="btn-neon text-sm px-3 py-1">üîÑ Restart</button>
                                </div>
                            </div>
                            <div class="relative bg-black rounded border-2 border-green-400" style="height: 500px;">
                                <canvas id="demoCanvas" width="800" height="500" class="w-full h-full"></canvas>
                                <div id="demoLoading" class="absolute inset-0 flex items-center justify-center text-white text-xl">
                                    Click Start to begin demo...
                                </div>
                            </div>
                        </div>

                        <!-- Demo Stats and Controls -->
                        <div class="space-y-4">
                            <!-- Real-time Stats -->
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <h4 class="text-lg font-bold text-blue-400 mb-3">üìä Live Stats</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Player Health:</span>
                                        <span class="text-red-400" id="demoPlayerHealth">100/100</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Player Energy:</span>
                                        <span class="text-blue-400" id="demoPlayerEnergy">100/100</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Score:</span>
                                        <span class="text-yellow-400" id="demoScore">0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Particles:</span>
                                        <span class="text-purple-400" id="demoParticles">0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Position:</span>
                                        <span class="text-green-400" id="demoPosition">400, 250</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Demo Controls -->
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <h4 class="text-lg font-bold text-purple-400 mb-3">üéÆ Controls</h4>
                                <div class="space-y-2 text-sm text-gray-300">
                                    <div><span class="text-yellow-400">WASD</span> - Move Player</div>
                                    <div><span class="text-yellow-400">SPACE</span> - Attack (15 Energy)</div>
                                    <div><span class="text-yellow-400">Q/E</span> - Dash (25 Energy)</div>
                                    <div><span class="text-yellow-400">CLICK</span> - Create Effects</div>
                                    <div><span class="text-yellow-400">ESC</span> - Pause</div>
                                </div>
                            </div>

                            <!-- Save/Load Demo -->
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <h4 class="text-lg font-bold text-green-400 mb-3">üíæ Save/Load</h4>
                                <div class="space-y-2">
                                    <button id="saveDemoBtn" class="btn-neon w-full text-sm">Save Demo State</button>
                                    <button id="loadDemoBtn" class="btn-neon w-full text-sm">Load Demo State</button>
                                </div>
                            </div>

                            <!-- System Integration -->
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <h4 class="text-lg font-bold text-red-400 mb-3">üîó Integration</h4>
                                <div class="space-y-2">
                                    <button id="syncCharacterBtn" class="btn-neon w-full text-sm">Sync Character Stats</button>
                                    <button id="syncInventoryBtn" class="btn-neon w-full text-sm">Sync Inventory</button>
                                    <button id="syncAbilitiesBtn" class="btn-neon w-full text-sm">Sync Abilities</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Initialize demo when modal opens
            initializeDemo();

            document.getElementById('closeDemoModal').addEventListener('click', () => {
                if (window.demoGameLoop) {
                    cancelAnimationFrame(window.demoGameLoop);
                }
                modal.remove();
            });
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
        }

        // Demo Game Integration
        let demoPlayer = null;
        let demoParticles = [];
        let demoScore = 0;
        let demoClicks = 0;
        let demoKeys = {};
        let demoTime = 0;
        let demoRunning = false;
        let demoCanvas = null;
        let demoCtx = null;

        function initializeDemo() {
            demoCanvas = document.getElementById('demoCanvas');
            demoCtx = demoCanvas.getContext('2d');

            // Initialize demo player with synced character stats
            syncCharacterToDemo();

            // Setup demo controls
            setupDemoControls();

            // Setup keyboard input
            setupDemoInput();
        }

        function setupDemoControls() {
            const startBtn = document.getElementById('startDemoBtn');
            const stopBtn = document.getElementById('stopDemoBtn');
            const restartBtn = document.getElementById('restartDemoBtn');
            const saveBtn = document.getElementById('saveDemoBtn');
            const loadBtn = document.getElementById('loadDemoBtn');
            const syncCharBtn = document.getElementById('syncCharacterBtn');
            const syncInvBtn = document.getElementById('syncInventoryBtn');
            const syncAbilBtn = document.getElementById('syncAbilitiesBtn');

            startBtn.addEventListener('click', startDemo);
            stopBtn.addEventListener('click', stopDemo);
            restartBtn.addEventListener('click', restartDemo);
            saveBtn.addEventListener('click', saveDemoState);
            loadBtn.addEventListener('click', loadDemoState);
            syncCharBtn.addEventListener('click', syncCharacterToDemo);
            syncInvBtn.addEventListener('click', syncInventoryToDemo);
            syncAbilBtn.addEventListener('click', syncAbilitiesToDemo);
        }

        function setupDemoInput() {
            window.addEventListener('keydown', (e) => {
                demoKeys[e.code] = true;

                // Handle demo-specific actions
                if (demoRunning) {
                    if (e.code === 'Space') {
                        e.preventDefault();
                        demoPlayerAttack();
                    }
                    if (e.code === 'KeyQ') {
                        e.preventDefault();
                        demoPlayerDash(Math.PI);
                    }
                    if (e.code === 'KeyE') {
                        e.preventDefault();
                        demoPlayerDash(0);
                    }
                    if (e.code === 'Escape') {
                        e.preventDefault();
                        stopDemo();
                    }
                }
            });

            window.addEventListener('keyup', (e) => {
                demoKeys[e.code] = false;
            });

            // Canvas click handler
            demoCanvas.addEventListener('click', (e) => {
                if (!demoRunning) return;

                const rect = demoCanvas.getBoundingClientRect();
                const scaleX = demoCanvas.width / rect.width;
                const scaleY = demoCanvas.height / rect.height;
                const x = (e.clientX - rect.left) * scaleX;
                const y = (e.clientY - rect.top) * scaleY;

                createDemoParticles(x, y);
                demoClicks++;
                demoScore += 10;
                updateDemoStats();
            });
        }

        function startDemo() {
            if (demoRunning) return;

            demoRunning = true;
            document.getElementById('demoLoading').style.display = 'none';
            document.getElementById('startDemoBtn').disabled = true;
            document.getElementById('stopDemoBtn').disabled = false;

            demoGameLoop = requestAnimationFrame(updateDemo);
            showNotification('Demo started!', 'success');
        }

        function stopDemo() {
            demoRunning = false;
            document.getElementById('startDemoBtn').disabled = false;
            document.getElementById('stopDemoBtn').disabled = true;

            if (window.demoGameLoop) {
                cancelAnimationFrame(window.demoGameLoop);
            }
            showNotification('Demo stopped!', 'warning');
        }

        function restartDemo() {
            stopDemo();
            resetDemo();
            setTimeout(startDemo, 100);
        }

        function resetDemo() {
            demoPlayer = createDemoPlayer();
            demoParticles = [];
            demoScore = 0;
            demoClicks = 0;
            demoTime = 0;
            updateDemoStats();
        }

        function createDemoPlayer() {
            return {
                x: demoCanvas.width / 2,
                y: demoCanvas.height / 2,
                width: 24,
                height: 32,
                speed: 250,
                vx: 0,
                vy: 0,
                health: window.character ? window.character.health : 100,
                maxHealth: window.character ? window.character.maxHealth : 100,
                energy: window.character ? window.character.mana : 100,
                maxEnergy: window.character ? window.character.maxMana : 100,
                facing: 'right',
                isMoving: false,
                animTime: 0,
                trail: []
            };
        }

        function updateDemo() {
            if (!demoRunning) return;

            const dt = 0.016; // ~60fps
            demoTime += dt;

            updateDemoPlayer(dt);
            updateDemoParticles(dt);
            renderDemo();

            updateDemoStats();

            demoGameLoop = requestAnimationFrame(updateDemo);
        }

        function updateDemoPlayer(dt) {
            if (!demoPlayer) return;

            demoPlayer.vx = 0;
            demoPlayer.vy = 0;
            demoPlayer.isMoving = false;

            // Movement input
            if (demoKeys['KeyW'] || demoKeys['ArrowUp']) {
                demoPlayer.vy = -demoPlayer.speed;
                demoPlayer.isMoving = true;
            }
            if (demoKeys['KeyS'] || demoKeys['ArrowDown']) {
                demoPlayer.vy = demoPlayer.speed;
                demoPlayer.isMoving = true;
            }
            if (demoKeys['KeyA'] || demoKeys['ArrowLeft']) {
                demoPlayer.vx = -demoPlayer.speed;
                demoPlayer.facing = 'left';
                demoPlayer.isMoving = true;
            }
            if (demoKeys['KeyD'] || demoKeys['ArrowRight']) {
                demoPlayer.vx = demoPlayer.speed;
                demoPlayer.facing = 'right';
                demoPlayer.isMoving = true;
            }

            // Diagonal movement normalization
            if (demoPlayer.vx !== 0 && demoPlayer.vy !== 0) {
                demoPlayer.vx *= 0.707;
                demoPlayer.vy *= 0.707;
            }

            // Update position
            demoPlayer.x += demoPlayer.vx * dt;
            demoPlayer.y += demoPlayer.vy * dt;

            // Keep player in bounds
            demoPlayer.x = Math.max(demoPlayer.width/2, Math.min(demoCanvas.width - demoPlayer.width/2, demoPlayer.x));
            demoPlayer.y = Math.max(demoPlayer.height/2, Math.min(demoCanvas.height - demoPlayer.height/2, demoPlayer.y));

            // Update animation time
            if (demoPlayer.isMoving) {
                demoPlayer.animTime += dt * 8;
            }

            // Update trail effect
            demoPlayer.trail.push({
                x: demoPlayer.x,
                y: demoPlayer.y,
                life: 1,
                time: Date.now()
            });

            // Remove old trail points
            demoPlayer.trail = demoPlayer.trail.filter(point => {
                point.life -= dt * 3;
                return point.life > 0;
            });

            // Regenerate energy slowly
            demoPlayer.energy = Math.min(demoPlayer.maxEnergy, demoPlayer.energy + dt * 20);
        }

        function demoPlayerAttack() {
            if (demoPlayer.energy >= 15) {
                demoPlayer.energy -= 15;
                const attackX = demoPlayer.x + (demoPlayer.facing === 'right' ? 30 : -30);
                createDemoParticles(attackX, demoPlayer.y);
                demoScore += 25;
            }
        }

        function demoPlayerDash(direction) {
            if (demoPlayer.energy >= 25) {
                const dashDistance = 100;
                demoPlayer.x += Math.cos(direction) * dashDistance;
                demoPlayer.y += Math.sin(direction) * dashDistance;
                demoPlayer.energy -= 25;

                // Keep in bounds after dash
                demoPlayer.x = Math.max(demoPlayer.width/2, Math.min(demoCanvas.width - demoPlayer.width/2, demoPlayer.x));
                demoPlayer.y = Math.max(demoPlayer.height/2, Math.min(demoCanvas.height - demoPlayer.height/2, demoPlayer.y));

                createDemoParticles(demoPlayer.x, demoPlayer.y);
            }
        }

        function createDemoParticles(x, y) {
            for (let i = 0; i < 15; i++) {
                demoParticles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 200,
                    vy: (Math.random() - 0.5) * 200,
                    life: 1,
                    decay: Math.random() * 0.02 + 0.01,
                    size: Math.random() * 5 + 2,
                    color: `hsl(${Math.random() * 360}, 70%, 60%)`
                });
            }
        }

        function updateDemoParticles(dt) {
            demoParticles = demoParticles.filter(particle => {
                particle.x += particle.vx * dt;
                particle.y += particle.vy * dt;
                particle.life -= particle.decay;
                particle.vx *= 0.98;
                particle.vy *= 0.98;
                return particle.life > 0;
            });
        }

        function renderDemo() {
            // Clear canvas
            demoCtx.fillStyle = 'rgba(10, 10, 10, 0.1)';
            demoCtx.fillRect(0, 0, demoCanvas.width, demoCanvas.height);

            // Background grid effect
            demoCtx.strokeStyle = 'rgba(0, 245, 147, ' + (0.1 + Math.sin(demoTime) * 0.05) + ')';
            demoCtx.lineWidth = 1;

            const gridSize = 50;
            for (let x = (Math.sin(demoTime * 0.5) * 10) % gridSize; x < demoCanvas.width; x += gridSize) {
                demoCtx.beginPath();
                demoCtx.moveTo(x, 0);
                demoCtx.lineTo(x, demoCanvas.height);
                demoCtx.stroke();
            }

            for (let y = (Math.cos(demoTime * 0.3) * 10) % gridSize; y < demoCanvas.height; y += gridSize) {
                demoCtx.beginPath();
                demoCtx.moveTo(0, y);
                demoCtx.lineTo(demoCanvas.width, y);
                demoCtx.stroke();
            }

            // Render player
            renderDemoPlayer();

            // Render particles
            demoParticles.forEach(particle => {
                demoCtx.save();
                demoCtx.globalAlpha = particle.life;
                demoCtx.fillStyle = particle.color;
                demoCtx.beginPath();
                demoCtx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                demoCtx.fill();
                demoCtx.restore();
            });

            // Render UI
            demoCtx.fillStyle = '#00f593';
            demoCtx.font = 'bold 20px Orbitron';
            demoCtx.textAlign = 'center';
            demoCtx.fillText('üéÆ GAME DEMO', demoCanvas.width / 2, 40);
        }

        function renderDemoPlayer() {
            if (!demoPlayer) return;

            // Render trail effect
            demoPlayer.trail.forEach((point, index) => {
                demoCtx.save();
                demoCtx.globalAlpha = point.life * 0.3;
                demoCtx.fillStyle = '#05d9e8';
                demoCtx.beginPath();
                demoCtx.arc(point.x, point.y, 3 * point.life, 0, Math.PI * 2);
                demoCtx.fill();
                demoCtx.restore();
            });

            demoCtx.save();

            // Player body (animated if moving)
            const bobOffset = demoPlayer.isMoving ? Math.sin(demoPlayer.animTime) * 2 : 0;
            const playerY = demoPlayer.y + bobOffset;

            // Player shadow
            demoCtx.save();
            demoCtx.globalAlpha = 0.3;
            demoCtx.fillStyle = '#000000';
            demoCtx.fillRect(demoPlayer.x - demoPlayer.width/2, demoPlayer.y + demoPlayer.height/2 - 2, demoPlayer.width, 4);
            demoCtx.restore();

            // Player body (main)
            demoCtx.fillStyle = '#ff206e';
            demoCtx.fillRect(demoPlayer.x - demoPlayer.width/2, playerY - demoPlayer.height/2, demoPlayer.width, demoPlayer.height);

            // Player glow effect
            demoCtx.save();
            demoCtx.shadowColor = '#ff206e';
            demoCtx.shadowBlur = 15;
            demoCtx.fillStyle = '#ff206e';
            demoCtx.fillRect(demoPlayer.x - demoPlayer.width/2 + 2, playerY - demoPlayer.height/2 + 2, demoPlayer.width - 4, demoPlayer.height - 4);
            demoCtx.restore();

            // Player details
            demoCtx.fillStyle = '#00f593';
            const eyeOffset = demoPlayer.facing === 'right' ? 4 : -4;
            demoCtx.fillRect(demoPlayer.x - 6 + eyeOffset, playerY - 8, 3, 3);
            demoCtx.fillRect(demoPlayer.x + 3 + eyeOffset, playerY - 8, 3, 3);

            // Chest emblem
            demoCtx.fillStyle = '#ffd700';
            demoCtx.fillRect(demoPlayer.x - 4, playerY - 2, 8, 6);

            demoCtx.restore();
        }

        function updateDemoStats() {
            if (!demoPlayer) return;

            document.getElementById('demoPlayerHealth').textContent = `${Math.round(demoPlayer.health)}/${demoPlayer.maxHealth}`;
            document.getElementById('demoPlayerEnergy').textContent = `${Math.round(demoPlayer.energy)}/${demoPlayer.maxEnergy}`;
            document.getElementById('demoScore').textContent = demoScore;
            document.getElementById('demoParticles').textContent = demoParticles.length;
            document.getElementById('demoPosition').textContent = `${Math.round(demoPlayer.x)}, ${Math.round(demoPlayer.y)}`;
        }

        // Synchronization functions
        function syncCharacterToDemo() {
            if (!window.character) return;

            if (!demoPlayer) {
                demoPlayer = createDemoPlayer();
            }

            demoPlayer.health = window.character.health;
            demoPlayer.maxHealth = window.character.maxHealth;
            demoPlayer.energy = window.character.mana;
            demoPlayer.maxEnergy = window.character.maxMana;

            updateDemoStats();
            showNotification('Character stats synced to demo!', 'success');
        }

        function syncInventoryToDemo() {
            // This would sync inventory items to demo effects
            showNotification('Inventory synced to demo!', 'success');
        }

        function syncAbilitiesToDemo() {
            // This would sync abilities to demo actions
            showNotification('Abilities synced to demo!', 'success');
        }

        // Save/Load functions
        function saveDemoState() {
            if (!demoPlayer) return;

            const demoState = {
                player: {
                    x: demoPlayer.x,
                    y: demoPlayer.y,
                    health: demoPlayer.health,
                    maxHealth: demoPlayer.maxHealth,
                    energy: demoPlayer.energy,
                    maxEnergy: demoPlayer.maxEnergy,
                    facing: demoPlayer.facing
                },
                gameState: {
                    score: demoScore,
                    clicks: demoClicks,
                    particles: demoParticles.length
                },
                timestamp: Date.now()
            };

            localStorage.setItem('demoGameState', JSON.stringify(demoState));
            showNotification('Demo state saved!', 'success');
        }

        function loadDemoState() {
            const savedState = localStorage.getItem('demoGameState');
            if (!savedState) {
                showNotification('No demo state to load!', 'warning');
                return;
            }

            try {
                const state = JSON.parse(savedState);

                if (!demoPlayer) {
                    demoPlayer = createDemoPlayer();
                }

                // Restore player state
                if (state.player) {
                    Object.assign(demoPlayer, state.player);
                }

                // Restore game state
                if (state.gameState) {
                    demoScore = state.gameState.score || 0;
                    demoClicks = state.gameState.clicks || 0;
                }

                updateDemoStats();
                showNotification('Demo state loaded!', 'success');
            } catch (error) {
                console.error('Failed to load demo state:', error);
                showNotification('Failed to load demo state!', 'error');
            }
        }

        function addUIButton() {
            const preview = document.getElementById('uiPreview');
            const button = document.createElement('button');
            button.className = 'btn-neon absolute';
            button.style.left = '20px';
            button.style.top = '20px';
            button.textContent = 'Test Button';
            button.onclick = () => showNotification('Button clicked!', 'info');
            preview.appendChild(button);
        }

        function addUILabel() {
            const preview = document.getElementById('uiPreview');
            const label = document.createElement('div');
            label.className = 'text-white font-bold absolute';
            label.style.left = '20px';
            label.style.top = '80px';
            label.textContent = 'Sample Label';
            preview.appendChild(label);
        }

        function addUIProgressBar() {
            const preview = document.getElementById('uiPreview');
            const progress = document.createElement('div');
            progress.className = 'absolute bg-gray-700 rounded-full h-4';
            progress.style.left = '20px';
            progress.style.top = '140px';
            progress.style.width = '200px';
            progress.innerHTML = '<div class="bg-green-400 h-full rounded-full transition-all duration-300" style="width: 75%"></div>';
            preview.appendChild(progress);
        }

        function addUIPanel() {
            const preview = document.getElementById('uiPreview');
            const panel = document.createElement('div');
            panel.className = 'absolute bg-gray-800 border border-gray-600 rounded-lg p-4';
            panel.style.left = '250px';
            panel.style.top = '20px';
            panel.style.width = '150px';
            panel.innerHTML = '<div class="text-white text-sm">Sample Panel</div>';
            preview.appendChild(panel);
        }

        function addUIInputField() {
            const preview = document.getElementById('uiPreview');
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'absolute bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white';
            input.style.left = '20px';
            input.style.top = '200px';
            input.style.width = '180px';
            input.placeholder = 'Enter text...';
            preview.appendChild(input);
        }

        function clearUIPreview() {
            const preview = document.getElementById('uiPreview');
            preview.innerHTML = '<div class="text-gray-400 text-center py-16">Add UI components to preview</div>';
        }

        function setUITheme(theme) {
            showNotification(`${theme} theme applied!`, 'success');
            // Theme application would be implemented in the UI manager
        }

        function exportUI() {
            const preview = document.getElementById('uiPreview');
            const config = {
                components: Array.from(preview.children).map(child => ({
                    type: child.tagName.toLowerCase(),
                    className: child.className,
                    style: child.style.cssText,
                    content: child.textContent || child.value || ''
                }))
            };
            localStorage.setItem('uiPreviewConfig', JSON.stringify(config));
            showNotification('UI layout exported!', 'success');
        }

        function saveUIConfig() {
            showNotification('UI configuration saved!', 'success');
        }

        function resetUI() {
            clearUIPreview();
            showNotification('UI reset!', 'warning');
        }

        // Comprehensive Save/Load System
        function saveProjectConfiguration() {
            const projectConfig = {
                timestamp: Date.now(),
                version: '1.0.0',
                character: {
                    health: window.character.health,
                    maxHealth: window.character.maxHealth,
                    mana: window.character.mana,
                    maxMana: window.character.maxMana,
                    level: window.character.level,
                    experience: window.character.experience,
                    strength: window.character.strength,
                    agility: window.character.agility,
                    intelligence: window.character.intelligence
                },
                inventory: {
                    capacity: window.inventoryManager.capacity,
                    inventory: Array.from(window.inventoryManager.inventory.entries()),
                    equipmentSlots: window.inventoryManager.equipmentSlots
                },
                abilities: {
                    abilities: window.abilityManager.abilities.map(ability => ({
                        name: ability.name,
                        description: ability.description,
                        type: ability.type,
                        resourceCost: ability.resourceCost,
                        resourceType: ability.resourceType,
                        cooldown: ability.cooldown,
                        damage: ability.damage,
                        elementalType: ability.elementalType
                    })),
                    hotbar: window.abilityManager.hotbar.slots.map(slot => slot ? slot.name : null)
                },
                dialog: window.dialogNodes ? {
                    nodes: Array.from(window.dialogNodes.entries())
                } : { nodes: [] },
                animation: {
                    target: document.getElementById('animationTarget')?.value || 'preview',
                    type: document.getElementById('animationType')?.value || 'fadeIn',
                    duration: document.getElementById('animationDuration')?.value || '1000',
                    direction: document.getElementById('animationDirection')?.value || 'left'
                },
                ui: {
                    theme: 'default',
                    components: []
                },
                gameEngine: {
                    fps: window.gameEngine.config.fps,
                    pixelArt: window.gameEngine.config.pixelArt,
                    audioEnabled: window.gameEngine.config.audioEnabled,
                    touchEnabled: window.gameEngine.config.touchEnabled
                }
            };

            // Save to localStorage
            localStorage.setItem('gameProjectConfig', JSON.stringify(projectConfig));

            // Also save to game engine's save system
            if (window.gameEngine) {
                window.gameEngine.saveGame('project_config', {
                    character: projectConfig.character,
                    inventory: projectConfig.inventory,
                    abilities: projectConfig.abilities
                });
            }

            showNotification('Project configuration saved successfully!', 'success');
            return projectConfig;
        }

        function loadProjectConfiguration() {
            const savedConfig = localStorage.getItem('gameProjectConfig');
            if (!savedConfig) {
                showNotification('No saved project configuration found!', 'warning');
                return null;
            }

            try {
                const config = JSON.parse(savedConfig);

                // Load character
                if (config.character) {
                    Object.assign(window.character, config.character);
                    window.character.experienceToNext = window.character.calculateExpToNext();
                    updateCharacterDisplay();
                }

                // Load inventory
                if (config.inventory) {
                    window.inventoryManager.capacity = config.inventory.capacity;
                    window.inventoryManager.inventory = new Map(config.inventory.inventory);
                    window.inventoryManager.equipmentSlots = config.inventory.equipmentSlots;
                    updateInventoryDisplay();
                }

                // Load abilities
                if (config.abilities) {
                    window.abilityManager.abilities = config.abilities.abilities.map(abilityData => {
                        // Recreate ability instances
                        if (abilityData.type === 'offensive') {
                            return new window.OffensiveAbility(
                                abilityData.name,
                                abilityData.description,
                                abilityData.damage,
                                'single',
                                abilityData.cooldown,
                                abilityData.resourceCost,
                                abilityData.resourceType
                            );
                        } else if (abilityData.type === 'defensive') {
                            return new window.DefensiveAbility(
                                abilityData.name,
                                abilityData.description,
                                10,
                                abilityData.cooldown,
                                'self',
                                abilityData.cooldown,
                                abilityData.resourceCost,
                                abilityData.resourceType
                            );
                        } else {
                            return new window.UtilityAbility(
                                abilityData.name,
                                abilityData.description,
                                'heal',
                                'self',
                                abilityData.cooldown,
                                abilityData.resourceCost,
                                abilityData.resourceType
                            );
                        }
                    });

                    // Load hotbar
                    config.abilities.hotbar.forEach((abilityName, index) => {
                        if (abilityName) {
                            const ability = window.abilityManager.abilities.find(a => a.name === abilityName);
                            if (ability) {
                                window.abilityManager.hotbar.assignAbility(index, ability);
                            }
                        }
                    });
                    updateAbilitiesDisplay();
                }

                // Load dialog
                if (config.dialog && config.dialog.nodes) {
                    window.dialogNodes = new Map(config.dialog.nodes);
                    updateDialogTree();
                }

                // Load animation settings
                if (config.animation) {
                    const targetEl = document.getElementById('animationTarget');
                    const typeEl = document.getElementById('animationType');
                    const durationEl = document.getElementById('animationDuration');
                    const directionEl = document.getElementById('animationDirection');

                    if (targetEl) targetEl.value = config.animation.target;
                    if (typeEl) typeEl.value = config.animation.type;
                    if (durationEl) durationEl.value = config.animation.duration;
                    if (directionEl) directionEl.value = config.animation.direction;
                }

                // Load game engine settings
                if (config.gameEngine && window.gameEngine) {
                    Object.assign(window.gameEngine.config, config.gameEngine);
                }

                showNotification('Project configuration loaded successfully!', 'success');
                return config;

            } catch (error) {
                console.error('Failed to load project configuration:', error);
                showNotification('Failed to load project configuration!', 'error');
                return null;
            }
        }

        function exportProjectConfiguration() {
            const config = saveProjectConfiguration();
            if (config) {
                const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `game-project-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                showNotification('Project exported successfully!', 'success');
            }
        }

        function importProjectConfiguration(file) {
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const config = JSON.parse(e.target.result);
                    localStorage.setItem('gameProjectConfig', JSON.stringify(config));
                    loadProjectConfiguration();
                    showNotification('Project imported successfully!', 'success');
                } catch (error) {
                    console.error('Failed to import project:', error);
                    showNotification('Failed to import project!', 'error');
                }
            };
            reader.readAsText(file);
        }

        // Documentation Access
        function openDocumentation(system) {
            const docs = {
                character: 'CHARACTER-STATS.md',
                inventory: 'INVENTORY-MANAGEMENT.md',
                abilities: 'POWERS-ABILITIES.md',
                dialog: 'DIALOG-SYSTEM.md',
                animation: 'ANIMATION-SYSTEM.md',
                ui: 'UI-ELEMENTS.md'
            };

            const docFile = docs[system];
            if (docFile) {
                // Open documentation in new window/tab
                window.open(`game-engine/docs/${docFile}`, '_blank');
            }
        }

        // Interactive Examples and Demos
        function runDemo(demoType) {
            switch(demoType) {
                case 'character':
                    // Demo character leveling
                    window.character.gainExperience(200);
                    updateCharacterDisplay();
                    showNotification('Character gained experience!', 'success');
                    break;

                case 'inventory':
                    // Add multiple items
                    for (let i = 0; i < 5; i++) {
                        addRandomItem();
                    }
                    showNotification('Added demo items to inventory!', 'success');
                    break;

                case 'abilities':
                    // Create a combat demo
                    addSampleAbilities();
                    showNotification('Abilities demo loaded!', 'success');
                    break;

                case 'animation':
                    // Run animation sequence
                    const element = document.getElementById('previewElement');
                    if (element) {
                        window.animationManager.sequence(
                            { style: element.style, position: { x: 0, y: 0 }, alpha: 1 },
                            [
                                { 'position.x': 100, duration: 500 },
                                { 'position.x': -100, duration: 500 },
                                { 'position.x': 0, duration: 500 },
                                { alpha: 0.5, duration: 300 },
                                { alpha: 1, duration: 300 }
                            ]
                        );
                        showNotification('Animation sequence running!', 'success');
                    }
                    break;

                case 'full':
                    // Run comprehensive demo
                    runDemo('character');
                    setTimeout(() => runDemo('inventory'), 1000);
                    setTimeout(() => runDemo('abilities'), 2000);
                    setTimeout(() => runDemo('animation'), 3000);
                    showNotification('Full system demo started!', 'info');
                    break;
            }
        }

        // Integration with Project Manager
        function integrateWithProjectManager() {
            // Add save/load buttons to project manager
            const quickActions = document.querySelector('.flex.flex-wrap.justify-center.gap-4.mb-8');
            if (quickActions) {
                const saveBtn = document.createElement('button');
                saveBtn.className = 'btn-neon';
                saveBtn.textContent = 'üíæ Save Project';
                saveBtn.onclick = saveProjectConfiguration;

                const loadBtn = document.createElement('button');
                loadBtn.className = 'btn-neon';
                loadBtn.textContent = 'üìÅ Load Project';
                loadBtn.onclick = loadProjectConfiguration;

                const exportBtn = document.createElement('button');
                exportBtn.className = 'btn-neon';
                exportBtn.textContent = 'üì§ Export Project';
                exportBtn.onclick = exportProjectConfiguration;

                quickActions.appendChild(saveBtn);
                quickActions.appendChild(loadBtn);
                quickActions.appendChild(exportBtn);
            }

            // Add documentation links
            const systemsContainer = document.querySelector('.mt-8 .grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-3.gap-6');
            if (systemsContainer) {
                const docLinks = document.createElement('div');
                docLinks.className = 'bg-gray-800 p-6 rounded-lg col-span-full';
                docLinks.innerHTML = `
                    <h3 class="text-xl font-bold text-green-400 mb-4">üìö Documentation</h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                        <button class="btn-neon text-xs py-2" onclick="openDocumentation('character')">Character</button>
                        <button class="btn-neon text-xs py-2" onclick="openDocumentation('inventory')">Inventory</button>
                        <button class="btn-neon text-xs py-2" onclick="openDocumentation('abilities')">Abilities</button>
                        <button class="btn-neon text-xs py-2" onclick="openDocumentation('dialog')">Dialog</button>
                        <button class="btn-neon text-xs py-2" onclick="openDocumentation('animation')">Animation</button>
                        <button class="btn-neon text-xs py-2" onclick="openDocumentation('ui')">UI</button>
                    </div>
                `;
                systemsContainer.appendChild(docLinks);
            }

            // Add demo buttons
            const demoSection = document.createElement('div');
            demoSection.className = 'bg-gray-800 p-6 rounded-lg col-span-full mt-6';
            demoSection.innerHTML = `
                <h3 class="text-xl font-bold text-yellow-400 mb-4">üéÆ Interactive Demos</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <button class="btn-neon py-3" onclick="runDemo('character')">Character Demo</button>
                    <button class="btn-neon py-3" onclick="runDemo('inventory')">Inventory Demo</button>
                    <button class="btn-neon py-3" onclick="runDemo('abilities')">Abilities Demo</button>
                    <button class="btn-neon py-3" onclick="runDemo('animation')">Animation Demo</button>
                </div>
                <div class="mt-4">
                    <button class="btn-neon w-full py-3" onclick="runDemo('full')">üéØ Run Full System Demo</button>
                </div>
            `;
            systemsContainer.appendChild(demoSection);
        }

        // Initialize the integration when systems are ready
        document.addEventListener('DOMContentLoaded', async () => {
            // Wait for systems to initialize first
            setTimeout(() => {
                integrateWithProjectManager();
            }, 2000);
        });
        
        function addWorkflowButtons() {
            const quickActionsContainer = document.querySelector('.flex.flex-wrap.justify-center.gap-4.mb-8');
            
            // Add workflow buttons
            const workflowButtons = [
                { id: 'quickStartBtn', text: '‚ö° Quick Start', workflow: 'quick-start', color: 'bg-green-600 hover:bg-green-500' },
                { id: 'cloneProjectBtn', text: 'üìã Clone Current', workflow: 'clone', color: 'bg-blue-600 hover:bg-blue-500' },
                { id: 'migrateBtn', text: 'üîÑ Migrate Project', workflow: 'migration', color: 'bg-purple-600 hover:bg-purple-500' },
                { id: 'restoreBtn', text: 'üîô Restore Backup', workflow: 'restore', color: 'bg-orange-600 hover:bg-orange-500' }
            ];
            
            workflowButtons.forEach(btn => {
                const button = document.createElement('button');
                button.id = btn.id;
                button.className = `${btn.color} text-white px-4 py-2 rounded-lg font-bold transition-all duration-300 transform hover:scale-105`;
                button.textContent = btn.text;
                button.addEventListener('click', () => {
                    executeWorkflowWithUI(btn.workflow);
                });
                quickActionsContainer.appendChild(button);
            });
        }
        
        async function executeWorkflowWithUI(workflowId) {
            try {
                showNotification(`Starting ${workflowId} workflow...`, 'info');
                
                const result = await window.projectWorkflow.executeWorkflow(workflowId);
                
                if (result.status === 'completed') {
                    showNotification(`${result.name} completed successfully!`, 'success');
                    // Refresh the project manager UI
                    if (window.projectManager) {
                        window.projectManager.updateUI();
                    }
                } else if (result.status === 'paused') {
                    showNotification(`${result.name} paused - user input required`, 'warning');
                }
                
            } catch (error) {
                console.error('Workflow error:', error);
                showNotification(`Workflow failed: ${error.message}`, 'error');
            }
        }
        
        function showWelcomeMessage() {
            const welcomeModal = document.createElement('div');
            welcomeModal.className = 'modal';
            welcomeModal.style.display = 'flex';
            welcomeModal.innerHTML = `
                <div class="modal-content max-w-4xl">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-green-400">üéÆ Welcome to Your Game Engine Project Manager!</h2>
                        <button id="closeWelcome" class="text-2xl text-gray-400 hover:text-white">&times;</button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <h3 class="text-xl font-bold text-blue-400 mb-3">üõ°Ô∏è Your Work is Protected</h3>
                            <ul class="text-gray-300 space-y-2">
                                <li>‚Ä¢ Automatic backups every 5 minutes</li>
                                <li>‚Ä¢ Your current Poker Doom project is preserved</li>
                                <li>‚Ä¢ Emergency restore available (Ctrl+Shift+R)</li>
                                <li>‚Ä¢ Multiple recovery options maintained</li>
                            </ul>
                        </div>
                        
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <h3 class="text-xl font-bold text-green-400 mb-3">üöÄ Easy Project Creation</h3>
                            <ul class="text-gray-300 space-y-2">
                                <li>‚Ä¢ Quick Start new projects (Ctrl+Shift+N)</li>
                                <li>‚Ä¢ Choose from multiple templates</li>
                                <li>‚Ä¢ Clone your current work instantly</li>
                                <li>‚Ä¢ Migrate existing projects seamlessly</li>
                            </ul>
                        </div>
                        
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <h3 class="text-xl font-bold text-yellow-400 mb-3">‚å®Ô∏è Keyboard Shortcuts</h3>
                            <ul class="text-gray-300 space-y-2">
                                <li>‚Ä¢ <code class="bg-gray-700 px-2 py-1 rounded">Ctrl+Shift+N</code> - Quick start new project</li>
                                <li>‚Ä¢ <code class="bg-gray-700 px-2 py-1 rounded">Ctrl+Shift+S</code> - Preserve current work</li>
                                <li>‚Ä¢ <code class="bg-gray-700 px-2 py-1 rounded">Ctrl+Shift+R</code> - Restore from backup</li>
                            </ul>
                        </div>
                        
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <h3 class="text-xl font-bold text-purple-400 mb-3">üéØ Available Templates</h3>
                            <ul class="text-gray-300 space-y-2">
                                <li>‚Ä¢ üÉè Poker Game - Card-based combat</li>
                                <li>‚Ä¢ üéÆ Full Game Engine - Complete framework</li>
                                <li>‚Ä¢ üèÉ Platformer - Side-scrolling action</li>
                                <li>‚Ä¢ ‚öîÔ∏è RPG Adventure - Role-playing game</li>
                                <li>‚Ä¢ üè∞ Strategy Game - Resource management</li>
                                <li>‚Ä¢ üß© Puzzle Game - Brain-teasing challenges</li>
                                <li>‚Ä¢ üèéÔ∏è Racing Game - High-speed competition</li>
                                <li>‚Ä¢ üèóÔ∏è Simulation - Complex system modeling</li>
                                <li>‚Ä¢ üìÑ Blank Project - Start from scratch</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="bg-gray-900 p-4 rounded-lg mb-6">
                        <h3 class="text-lg font-bold text-pink-400 mb-2">üí° Pro Tips</h3>
                        <ul class="text-gray-300 space-y-1 text-sm">
                            <li>‚Ä¢ Use <strong>Quick Start</strong> to create new projects while automatically preserving your current work</li>
                            <li>‚Ä¢ Try <strong>Clone Current</strong> to experiment with variations of your existing project</li>
                            <li>‚Ä¢ The system automatically backs up your work - you can always restore if needed</li>
                            <li>‚Ä¢ Use browser console commands like <code class="bg-gray-700 px-1 rounded">quickStart()</code> for rapid workflows</li>
                        </ul>
                    </div>
                    
                    <div class="flex gap-4">
                        <button id="startQuickTour" class="btn-neon flex-1">üöÄ Start Quick Project</button>
                        <button id="closeWelcomeBtn" class="bg-gray-600 px-6 py-3 rounded-lg hover:bg-gray-500">I'm Ready!</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(welcomeModal);
            
            // Event listeners
            document.getElementById('closeWelcome').addEventListener('click', () => {
                welcomeModal.remove();
            });
            
            document.getElementById('closeWelcomeBtn').addEventListener('click', () => {
                welcomeModal.remove();
            });
            
            document.getElementById('startQuickTour').addEventListener('click', () => {
                welcomeModal.remove();
                executeWorkflowWithUI('quick-start');
            });
            
            // Close on outside click
            welcomeModal.addEventListener('click', (e) => {
                if (e.target === welcomeModal) {
                    welcomeModal.remove();
                }
            });
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-50 transform transition-all duration-300 ${
                type === 'success' ? 'bg-green-600' :
                type === 'error' ? 'bg-red-600' :
                type === 'warning' ? 'bg-yellow-600' :
                'bg-blue-600'
            }`;
            notification.textContent = message;
            
            // Add icon based on type
            const icon = type === 'success' ? '‚úÖ' : 
                        type === 'error' ? '‚ùå' : 
                        type === 'warning' ? '‚ö†Ô∏è' : 'üí°';
            notification.textContent = `${icon} ${message}`;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Remove after delay
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }
    </script>
    <!-- Enhanced module loading with error handling and full system integration -->
    <script type="module">
        try {
            const [
                { ParticleSystem },
                { AnimationManager },
                { GameEngine },
                { Character },
                { InventoryManager, Item, Weapon, Armor, Consumable },
                { DialogManager },
                { EventBus },
                { ResourceManager },
                { Renderer },
                { AbilityManager, OffensiveAbility, DefensiveAbility, UtilityAbility }
            ] = await Promise.all([
                import('./game-engine/src/effects/ParticleSystem.js'),
                import('./game-engine/src/effects/AnimationManager.js'),
                import('./game-engine/src/core/GameEngine.js'),
                import('./game-engine/src/core/Character.js'),
                import('./game-engine/src/core/InventoryManager.js'),
                import('./game-engine/src/ui/DialogManager.js'),
                import('./game-engine/src/core/EventBus.js'),
                import('./game-engine/src/core/ResourceManager.js'),
                import('./game-engine/src/core/Renderer.js'),
                import('./game-engine/src/core/AbilityManager.js')
            ]);

            // Bind imported modules to global window object
            window.ParticleSystem = ParticleSystem;
            window.AnimationManager = AnimationManager;
            window.GameEngine = window.GameEngine || GameEngine;
            window.Character = Character;
            window.InventoryManager = InventoryManager;
            window.Item = Item;
            window.Weapon = Weapon;
            window.Armor = Armor;
            window.Consumable = Consumable;
            window.DialogManager = DialogManager;
            window.EventBus = EventBus;
            window.ResourceManager = ResourceManager;
            window.Renderer = Renderer;
            window.AbilityManager = AbilityManager;
            window.OffensiveAbility = OffensiveAbility;
            window.DefensiveAbility = DefensiveAbility;
            window.UtilityAbility = UtilityAbility;

            console.log('Project Manager: All engine modules loaded and bound successfully');

            // Enhanced system initialization with proper integration
            const initializeSystems = async () => {
                try {
                    // Initialize global instances
                    if (!window.character) {
                        window.character = new Character({
                            health: 100,
                            maxHealth: 100,
                            mana: 50,
                            maxMana: 50,
                            level: 1,
                            experience: 0,
                            strength: 10,
                            agility: 10,
                            intelligence: 10
                        });
                    }

                    if (!window.inventoryManager) {
                        window.inventoryManager = new InventoryManager(50);
                    }

                    if (!window.abilityManager) {
                        window.abilityManager = new AbilityManager(window.character, window.gameEngine);
                    }

                    // Add default abilities if none exist
                    if (window.abilityManager && window.abilityManager.abilities.length === 0) {
                        const fireBolt = new OffensiveAbility('Fire Bolt', 'Hurls a bolt of fire', 25, 'single', 2.0, 15, 'mana');
                        const shieldWall = new DefensiveAbility('Shield Wall', 'Creates a protective barrier', 10, 5.0, 'self', 3.0, 20, 'mana');
                        const healSelf = new UtilityAbility('Heal', 'Restores health', (char) => char.heal(30), 'self', 2.5, 25, 'mana');
                        window.abilityManager.addAbility(fireBolt);
                        window.abilityManager.addAbility(shieldWall);
                        window.abilityManager.addAbility(healSelf);
                    }

                    // Add default inventory items
                    if (window.inventoryManager && window.inventoryManager.inventory.size === 0) {
                        const healthPotion = new Consumable(1, 'Health Potion', 'Restores 50 HP', (char) => char.heal(50), 3, 'common', 25);
                        const ironSword = new Weapon(2, 'Iron Sword', 'A sturdy blade', 15, 'sword', 'common', 100);
                        window.inventoryManager.addItem(healthPotion);
                        window.inventoryManager.addItem(ironSword);
                    }

                    console.log('Project Manager: Systems initialized with module instances');
                } catch (initError) {
                    console.warn('Project Manager: Failed to initialize some systems:', initError);
                }
            };

            // Initialize systems after a brief delay to ensure DOM is ready
            setTimeout(initializeSystems, 500);

        } catch (e) {
            console.warn('Project Manager: Failed to load engine modules:', e);
            // Provide fallback initialization
            if (!window.character) {
                window.character = {
                    health: 100, maxHealth: 100, mana: 50, maxMana: 50,
                    level: 1, experience: 0, strength: 10, agility: 10, intelligence: 10
                };
            }
            if (!window.inventoryManager) {
                window.inventoryManager = { inventory: new Map(), equipmentSlots: {} };
            }
            if (!window.abilityManager) {
                window.abilityManager = { abilities: [] };
            }
        }
    </script>

    <!-- Simple EventBus wiring proof-of-concept (non-breaking) -->
    <script>
        (function(){
            try {
                const bus = (window.gameEngine && window.gameEngine.eventBus) ? window.gameEngine.eventBus : null;
                if (bus) {
                    // Handle notifications via event bus
                    bus.on('ui:notify', (payload) => {
                        try {
                            if (window.showNotification) {
                                window.showNotification(payload?.message || 'Notification', payload?.type || 'info');
                            } else {
                                const n = document.createElement('div');
                                n.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.8);color:#fff;padding:10px 16px;border-radius:8px;z-index:99999;font-family:monospace;';
                                n.textContent = payload?.message || 'Notification';
                                document.body.appendChild(n);
                                setTimeout(()=> n.remove(), payload?.duration || 2000);
                            }
                        } catch(e) { console.warn('ui:notify failed', e); }
                    });
                    // Trigger engine shake via bus
                    bus.on('engine:shake', (p) => { try { window.gameEngine?.shake?.(p?.intensity||5, p?.duration||200); } catch(e){} });

                    // Character event handlers (non-breaking)
                    bus.on('character:adjust', (p) => { try { if (typeof adjustAttribute === 'function') adjustAttribute(p?.attr, p?.amount); } catch(e){} });
                    bus.on('character:gainXP', (p) => { try { if (typeof gainExperience === 'function') gainExperience(p?.amount||0); } catch(e){} });
                    bus.on('character:heal', (p) => { try { if (typeof healCharacter === 'function') healCharacter(p?.amount||0); } catch(e){} });
                    bus.on('character:restoreMana', (p) => { try { if (typeof restoreMana === 'function') restoreMana(p?.amount||0); } catch(e){} });
                    bus.on('character:damage', (p) => { try { if (typeof takeDamage === 'function') takeDamage(p?.amount||0); } catch(e){} });
                }
                // Emit click telemetry for major buttons
                const emit = (event, data) => { try { bus && bus.emit(event, data); } catch(e){} };
                const ids = ['newProjectBtn','importProjectBtn','backupAllBtn','settingsBtn','openProjectBtn','duplicateProjectBtn','exportProjectBtn','deleteProjectBtn','characterBtn','inventoryBtn','abilitiesBtn','dialogBtn','animationBtn','uiBtn','demoBtn'];
                ids.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.addEventListener('click', () => emit('ui:clicked', { id }), { passive: true });
                });
            } catch (e) {
                console.warn('PM event wiring setup failed', e);
            }
        })();
    </script>

    <!-- Connect to external engine demo if not already wired -->
    <script>
        if (typeof window.showDemoPanel !== 'function') {
            window.showDemoPanel = function showDemoPanel() {
                try {
                    window.open('./game-engine/index.html', 'EngineDemo', 'width=1400,height=900,menubar=yes,toolbar=yes,scrollbars=yes,resizable=yes');
                } catch (e) {
                    console.warn('Failed to open external engine demo:', e);
                }
            };
            console.log('Project Manager: connected to external engine demo launcher.');
        }
    </script>
</body>
</html>
